{"version":3,"sources":["webpack://toad/webpack/bootstrap","webpack://toad/./src/action.ts","webpack://toad/./src/controller.ts","webpack://toad/./src/dom.ts","webpack://toad/./src/matrix.ts","webpack://toad/./src/model.ts","webpack://toad/./src/signal.ts","webpack://toad/./src/svg.ts","webpack://toad/./src/table/ArrayTableModel.ts","webpack://toad/./src/table/SelectionModel.ts","webpack://toad/./src/table/TableModel.ts","webpack://toad/./src/table/TableView.ts","webpack://toad/./src/table/TypedTableModel.ts","webpack://toad/./src/table/table.ts","webpack://toad/./src/table/tree.ts","webpack://toad/./src/toad.ts","webpack://toad/./src/view.ts","webpack://toad/./src/view/button.ts","webpack://toad/./src/view/checkbox.ts","webpack://toad/./src/view/menu.ts","webpack://toad/./src/view/slider.ts","webpack://toad/./src/view/text.ts","webpack://toad/./src/view/textarea.ts","webpack://toad/./src/view/toolbutton.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","Action","Model","parent","title","super","this","signal","Signal","_enabled","placeHolder","Error","enabled","modified","trigger","data","Controller","modelId2Models","Map","modelId2Views","view2ModelIds","sigChanged","actionId","callback","action","undefined","add","_registerModel","modelId","model","modelsForModelId","Set","set","viewsForModelId","view","setModel","controller","console","log","modelIdsForView","modelsForView","modelIds","views","delete","size","entry","clear","registerModel","registerAction","TextModel","HtmlModel","BooleanModel","options","NumberModel","template","root","dom","instantiateTemplate","registerViews","querySelectorAll","element","registerView","getModelId","e","getActionId","href","shadow","document","createElement","style","position","left","top","right","bottom","backgroundColor","opacity","body","appendChild","link","linkList","head","availableLink","dispatchEvent","Event","rel","onload","event","import","querySelector","content","importNode","frame","border","removeChild","globalController","text","boolean","tmpl","z","node","selector","txt","createTextNode","src","img","n0","n1","parentNode","firstChild","target","documentMouseMove","MouseEvent","stopPropagation","documentMouseUp","removeEventListener","capture","pointerEvents","addEventListener","preventDefault","attribute","getAttribute","nodeName","first","second","parentsOfFirstNode","firstPrevious","secondPrevious","lookup","child","childNodes","Matrix","matrix","m11","m12","m21","m22","tX","tY","n11","n12","n21","n22","nX","nY","point","x","y","append","radiant","Math","cos","sin","GenericModel","_value","promise","String","min","max","step","OptionModelBase","_stringValue","v","stringValue","_map","id","has","SignalLink","callbacks","Array","push","length","splice","locked","triggered","x1","y1","x2","y2","createElementNS","setAttributeNS","width","height","cx","cy","ArrayTableModel","TableModel","column","col","row","TextView","SelectionModel","TableEditMode","SELECT_ROW","TablePos","colCount","rowCount","getPropertyValue","propertyName","pixel","substr","Number","parseFloat","pixelToNumber","window","getComputedStyle","horizontalPadding","textContent","treeStyle","TableView","GenericView","insideGoTo","rootDiv","className","onkeydown","selectionModel","toggleRowSelection","SELECT_CELL","pos","toggleCellSelection","headDiv","overflow","headTable","headHead","headRow","bodyDiv","onscroll","scrollLeft","bodyTable","onmousedown","srcElement","tagName","goToField","bodyBody","bodyRow","zeroSize","margin","padding","inputDiv","background","genericEvent","relatedTarget","order","goTo","attachShadow","shadowRoot","connectedCallback","remove","updateView","updateSelection","constructor","updateHeader","updateBody","setTimeout","adjustInternalTables","fillerForMissingScrollbar","noHeader","children","cell","tag","minWidth","getColumnHead","innerHTML","innerText","display","paddingTop","paddingBottom","fieldModel","getFieldModel","getFieldView","EDIT_CELL","prepareFieldAtPosition","tabIndex","allSelected","selected","classList","headWidth","clientWidth","bodyWidth","maxWidth","offsetWidth","flag","toggle","scrollIntoViewIfNeeded","scrollIntoView","rowElement","boundary","getBoundingClientRect","td","tbody","parentElement","navigator","userAgent","indexOf","offsetLeft","offsetTop","clientHeight","focus","prepareFieldAtElement","fieldView","getElementAt","positionOfField","onblur","unadjustInternalTables","shiftKey","hasFocus","activeElement","FocusEvent","replaceChild","adjustInputToElement","customElements","define","TypedTableModel","nodeClass","tableModelLocators","registerTableModelLocator","locator","field","TableEventType","TableEvent","type","index","TreeModel","rows","nn","createNode","setRoot","Row","setNext","getRoot","unshift","getNext","setDown","depth","INSERT_ROW","count","nodeCount","getDown","down","subtreeSize","next","REMOVED_ROW","chain","open","TreeNodeModel","Node","label","counter","indent","repeat","print","dx","dy","TreeNodeView","View","svg","rectangle","line","j","NoModel","MyTreeModel","tree","addSiblingAfter","addChildAfter","OptionModel","ActionView","SlotView","ButtonView","ToolButton","CheckboxView","MenuButton","SliderView","createTableModel","myTreeTest","TextArea","TextTool","Template","Dialog","unbind","ToadIf","HTMLElement","hasAttribute","error","unregisterView","disconnectedCallback","buttonStyle","button","onclick","disabled","_observer","MutationObserver","record","observer","_timer","clearTimeout","observe","childList","subtree","characterData","isEnabled","checkboxStyle","rect","checkmark","oldValue","newValue","updateModel","removeAttribute","setAttribute","menuStyle","MenuState","Type","shortcut","parentView","span","flexGrow","MenuHelper","vertical","closeOnClose","state","WAIT","Menu","layout2nodes","referenceActions","createShadowDOM","newnode","attributeOrUndefined","str","strpos","findNode","isAvailable","createWindowAt","deleteWindow","MenuEntry","MenuSpacer","PopupMenu","parentButton","popup","show","master","parentBoundary","popupBoundary","innerHeight","innerWidth","placePopupHorizontal","placePopupVertical","menuButton","buttonDown","DOWN","activate","UP_N_HOLD","active","DOWN_N_HOLD","onmouseup","documentMouseDown","collapse","DOWN_N_OUTSIDE","deactivate","DOWN_N_INSIDE_AGAIN","onmouseout","inside","onmouseover","insertBefore","hide","oldActive","closePopup","openPopup","input","oninput","textStyle","blur","textareaStyle","texttool","toolbar","buttonH1","execCommand","update","buttonH2","buttonH3","buttonH4","buttonBold","buttonItalic","buttonUnderline","buttonStrikeThrough","buttonSubscript","buttonSuperscript","buttonJustifyLeft","buttonJustifyCenter","buttonJustifyRight","buttonUnorderedList","buttonOrderedList","queryCommandValue","queryCommandState","contentEditable","nodeType","metaKey","updateTextTool","onkeyup","toolbuttonStyle","getValue","isValidStringValue"],"mappings":"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","file":"toad.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/toad.ts\");\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { Model } from \"./model\"\nimport { Signal } from \"./signal\"\n\nexport class Action extends Model {\n  signal: Signal\n  title: string\n  \n  _enabled: boolean\n\n  constructor(parent: HTMLElement | undefined, title: string) {\n    super()\n    this.signal = new Signal()\n    this.title = title\n    this._enabled = true\n  }\n  \n  set value(placeHolder: any) {\n    throw Error(\"Action.value can not be assigned a value\")\n  }\n\n  get value(): any {\n    throw Error(\"Action.value can not return a value\")\n  }\n\n  set enabled(enabled: boolean) {\n    if (this._enabled == enabled)\n      return\n    this._enabled = enabled\n    this.modified.trigger()\n  }\n  \n  get enabled(): boolean {\n    return this._enabled\n  }\n  \n  trigger(data?: any): void {\n    if (!this._enabled)\n      return\n    this.signal.trigger(data)\n  }\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport * as dom from \"./dom\"\nimport { Model, TextModel, HtmlModel, BooleanModel, NumberModel } from \"./model\"\nimport { View } from \"./view\"\nimport { Action } from \"./action\"\nimport { Signal } from \"./signal\"\n\n// HTML Imports Working Draft\ndeclare global {\n  interface HTMLLinkElement {\n    import?: Document\n  }\n}\n\nexport class Controller {\n  modelId2Models: Map<string, Set<Model>>\n  modelId2Views: Map<string, Set<View>>\n  view2ModelIds: Map<View, Set<string>>\n  \n  sigChanged: Signal\n  \n  constructor() {\n    this.modelId2Models = new Map<string, Set<Model>>()\n    this.modelId2Views = new Map<string, Set<View>>()\n    this.view2ModelIds = new Map<View, Set<string>>()\n    this.sigChanged = new Signal()\n  }\n\n  registerAction(actionId: string, callback: () => void): Action {\n    // console.log(`registerAction(\"${actionId}\", <callback>)`)\n    let action = new Action(undefined, actionId)\n    action.signal.add(callback)\n    this._registerModel(\"A:\"+actionId, action)\n    return action\n  }\n  \n  registerModel(modelId: string, model: Model): void {\n    this._registerModel(\"M:\"+modelId, model)\n  }\n  \n  _registerModel(modelId: string, model: Model): void {\n    let modelsForModelId = this.modelId2Models.get(modelId)\n    if (!modelsForModelId) {\n      modelsForModelId = new Set<Model>()\n      this.modelId2Models.set(modelId, modelsForModelId)\n    }\n  \n    modelsForModelId.add(model)\n    \n    let viewsForModelId = this.modelId2Views.get(modelId)\n    if (!viewsForModelId)\n      return\n  \n    for(let view of viewsForModelId) {\n      view.setModel(model)\n    }\n  }\n\n  registerView(modelId: string, view: View): void {\n    if (view.controller && view.controller!==this) {\n      console.log(\"error: attempt to register view more than once at different controllers\")\n      return\n    }\n    view.controller = this\n  \n    let modelIdsForView = this.view2ModelIds.get(view)\n    if (!modelIdsForView) {\n      modelIdsForView = new Set<string>()\n      this.view2ModelIds.set(view, modelIdsForView)\n    }\n    modelIdsForView.add(modelId)\n  \n    let viewsForModelId = this.modelId2Views.get(modelId)\n    if (!viewsForModelId) {\n      viewsForModelId = new Set<View>()\n      this.modelId2Views.set(modelId, viewsForModelId)\n    }\n    viewsForModelId.add(view)\n    \n    let modelsForView = this.modelId2Models.get(modelId)\n    if (!modelsForView)\n      return\n\n    for(let model of modelsForView) {\n        view.setModel(model)\n    }\n  }\n  \n  unregisterView(view: View): void {\n    if (!view.controller)\n      return\n    if (view.controller !== this)\n      throw Error(\"attempt to unregister view from wrong controller\")\n  \n    let modelIds = this.view2ModelIds.get(view)\n    if (!modelIds)\n      return\n\n    for(let modelId of modelIds) {\n      let views = this.modelId2Views.get(modelId)\n      if (!views)\n        continue\n      views.delete(view)\n      if (views.size === 0) {\n        this.modelId2Views.delete(modelId)\n      }\n      view.setModel(undefined)\n    }\n  }\n  \n  clear(): void {\n    for(let entry of this.view2ModelIds) {\n      entry[0].setModel(undefined)\n    }\n    this.modelId2Models.clear()\n    this.modelId2Views.clear()\n    this.view2ModelIds.clear()\n  }\n  \n  bind(modelId: string, model: Model): void {\n    this.registerModel(modelId, model)\n  }\n  \n  action(actionId: string, callback: () => void): Action {\n    return this.registerAction(actionId, callback)\n  }\n  \n  text(modelId: string, value: string): TextModel {\n    let model = new TextModel(value)\n    this.bind(modelId, model)\n    return model\n  }\n\n  html(modelId: string, value: string): HtmlModel {\n    let model = new HtmlModel(value)\n    this.bind(modelId, model)\n    return model\n  }\n\n  boolean(modelId: string, value: boolean): BooleanModel {\n    let model = new BooleanModel(value)\n    this.bind(modelId, model)\n    return model\n  }\n  \n  number(modelId: string, value: number, options: any): NumberModel {\n    let model = new NumberModel(value, options)\n    this.bind(modelId, model)\n    return model\n  }\n}\n\nexport class Template extends Controller {\n  root: DocumentFragment\n\n  constructor(template: string) {\n    super()\n    this.root = dom.instantiateTemplate(template)\n    this.registerViews()\n  }\n  \n  registerViews() {\n    let views = this.root.querySelectorAll(\"[model]\")\n    for(let element of views) {\n      //if (element.nodeName.toUpperCase().substring(0,4)!==\"TOAD-\")\n      //  continue\n      let view = element as View\n      if (!view)\n        continue\n      try {\n        this.registerView(view.getModelId(), view)\n      }\n      catch(e) {\n      }\n    }\n    \n    views = this.root.querySelectorAll(\"[action]\")\n    for(let element of views) {\n      //if (element.nodeName.toUpperCase().substring(0,4)!==\"TOAD-\")\n      //  continue\n      let view = element as View\n      if (!view)\n        continue\n//      view.controller = this\n      try {\n        this.registerView(view.getActionId(), view)\n      }\n      catch(e) {\n      }\n    }\n    \n  }\n  \n  openHref(href: string) {\n  }\n}\n\nexport class Dialog extends Controller {\n  root?: DocumentFragment\n  shadow?: HTMLElement\n  frame?: HTMLElement\n  \n  constructor() {\n    super()\n  }\n\n  open(href: string): void {\n    let shadow = document.createElement(\"div\")\n    shadow.style.position = \"absolute\"\n    shadow.style.left = \"0\"\n    shadow.style.top = \"0\"\n    shadow.style.right = \"0\"\n    shadow.style.bottom = \"0\"\n    shadow.style.backgroundColor = \"#aaa\"\n    shadow.style.opacity = \"0.5\"\n    this.shadow = shadow\n    document.body.appendChild(shadow)\n  \n    let linkList = document.head.querySelectorAll(\"link[rel=import]\")\n    let link\n    for(let availableLink of linkList) {\n      if ((availableLink as HTMLLinkElement).href === href) {\n        link = availableLink\n        break\n      }\n    }\n\n    if (!link) {\n      let link = document.createElement(\"link\")\n      link.rel = \"import\"\n      link.href = href\n      link.onload = (event) => {\n        let template = link.import!.querySelector(\"template\")\n        if (!template)\n          throw Error(\"toad.openDialog: failed to find template in '\"+href+\"'\")\n          \n        let content = document.importNode(template.content, true)\n        this.registerViews(content)\n        \n        let frame = document.createElement(\"div\")\n        frame.style.position = \"absolute\"\n        frame.style.left = \"5%\"\n        frame.style.top = \"5%\"\n        frame.style.right = \"5%\"\n        frame.style.bottom = \"5%\"\n        frame.style.backgroundColor = \"#fff\"\n        frame.style.border = \"solid 2px #000\"\n        \n        frame.appendChild(content)\n        document.body.appendChild(frame)\n        this.frame = frame\n      }\n      document.head.appendChild(link)\n    } else {\n      link.dispatchEvent(new Event(\"load\"))\n    }\n  }\n  \n  close(): void {\n    if (this.frame)\n      document.body.removeChild(this.frame)\n    if (this.shadow)\n      document.body.removeChild(this.shadow)\n  }\n\n  registerViews(root: DocumentFragment) {\n    let views = root.querySelectorAll(\"[model]\")\n    for(let element of views) {\n      //if (element.nodeName.toUpperCase().substring(0,4)!==\"TOAD-\")\n      //  continue\n      let view = element as View\n      if (!view)\n        continue\n      try {\n        this.registerView(view.getModelId(), view)\n      }\n      catch(e) {\n      }\n    }\n    \n    views = root.querySelectorAll(\"[action]\")\n    for(let element of views) {\n      //if (element.nodeName.toUpperCase().substring(0,4)!==\"TOAD-\")\n      //  continue\n      let view = element as View\n      if (!view)\n        continue\n//      view.controller = this\n      try {\n        this.registerView(view.getActionId(), view)\n      }\n      catch(e) {\n      }\n    }\n    \n  }\n}\n\nexport let globalController = new Controller()\n\nexport function bind(modelId: string, model: Model) {\n  globalController.bind(modelId, model)\n}\n\nexport function action(actionId: string, action: () => void): Action { // FIXME: deprecated\n  return globalController.registerAction(actionId, action)\n}\n\nexport function unbind() {\n  globalController.clear()\n}\n\nexport function text(modelId: string, value: string): TextModel {\n  return globalController.text(modelId, value)\n}\n\nexport function boolean(modelId: string, value: boolean): BooleanModel {\n  return globalController.boolean(modelId, value)\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n *\n * Utility functions to work with the DOM.\n *\n */\n\nexport function instantiateTemplate(name: string): DocumentFragment {\n  return tmpl(name);\n}\n\nexport function tmpl(name: string): DocumentFragment {\n  let t = document.querySelector('template[id=\"'+name+'\"]');\n  if (!t) {\n    throw new Error(\"failed to find template '\"+name+\"'\");\n  }\n  let x = t as HTMLTemplateElement;\n  let z: DocumentFragment = x.content;\n  let y = document.importNode(z, true);\n  return y;\n}\n\nexport function find(node: Element|DocumentFragment, selector: string): Element|null {\n  return node.querySelector(selector);\n}\n\nexport function tag(name: string): HTMLElement { return document.createElement(name); } // FIXME: stupid idea with TypeScript\nexport function txt(txt: string): Text { return document.createTextNode(txt); } // FIXME: stupid idea with TypeScript\nexport function img(src: string): HTMLImageElement {\n  let img = document.createElement(\"img\") as HTMLImageElement\n  img.src = src\n  return img\n}\n\nexport function add(n0: Node, n1: Node): void { n0.appendChild(n1); }\nexport function remove(n: Node): void { \n  if (!n.parentNode)\n    throw Error(\"element has no parent\");\n  n.parentNode.removeChild(n);\n}\nexport function erase(n: Element): void { while(n.firstChild) n.removeChild(n.firstChild); }\n\nexport function grabMouse(event: MouseEvent) {\n  let target = event.target as HTMLElement\n//  console.log(event)\n    \n  let documentMouseMove = (event: MouseEvent) => {\n//  console.log(\"document.moveMove\", target)\n    target.dispatchEvent(new MouseEvent(\"mousemove\", event))\n    // srcElement, target, toElement, offsetX, offsetY, ...?\n//    target.onmousemove(event)\n    event.stopPropagation()\n  }\n\n  let documentMouseUp = (event: MouseEvent) => {\n//  console.log(\"document.mouseUp\", target)\n    target.dispatchEvent(new MouseEvent(\"mouseup\", event))\n//    target.onmouseup(event)\n    document.removeEventListener(\"mousemove\", documentMouseMove, {capture: true})\n    document.removeEventListener(\"mouseup\", documentMouseUp, {capture: true})\n    document.body.style.pointerEvents = \"auto\"\n    event.stopPropagation()\n  }\n\n  document.addEventListener(\"mousemove\", documentMouseMove, {capture: true})\n  document.addEventListener(\"mouseup\", documentMouseUp, {capture: true})\n  document.body.style.pointerEvents = \"none\"\n  event.preventDefault()\n  event.stopPropagation()\n}\n\nexport function attribute(element: Element, name: string): string {\n  let attribute = element.getAttribute(name)\n  if (attribute === null) {\n    console.log(\"missing attribute '\"+name+\"' in \", element)\n    throw Error(\"missing attribute '\"+name+\"' in \"+element.nodeName)\n  }\n  return attribute\n}\n\nexport function attributeOrUndefined(element: Element, name: string): string|undefined {\n  let attribute = element.getAttribute(name)\n  return attribute === null ? undefined : attribute\n}\n\n// return true when first appears before second within the dom hierachy\nexport function order(first: Node, second: Node): boolean {\n  let parentsOfFirstNode = new Map<Node, Node>()\n  let node: Node|null\n  \n  let firstPrevious = first\n  node = first\n  while(true) {\n    firstPrevious = node\n    node = node.parentNode\n    if (!node)\n      break\n    parentsOfFirstNode.set(node, firstPrevious)\n  }\n\n  let secondPrevious = second\n  node = second\n  while(node) {\n    secondPrevious = node\n    node = node.parentNode\n    if (!node)\n      throw Error(\"fuck\")\n    let lookup = parentsOfFirstNode.get(node)\n    if (lookup) {\n      firstPrevious = lookup\n      break\n    }\n    node = node.parentNode\n  }\n  if (!node)\n    throw Error(\"fuck\")\n  \n  for(let child of node!.childNodes) {\n    if (child === firstPrevious)\n      return true\n    if (child === secondPrevious)\n      return false\n  }\n  throw Error(\"fuck\")\n}\n","export interface Point {\n    x: number\n    y: number\n}\n\nexport interface MatrixStruct {\n    m11: number\n    m12: number\n    m21: number\n    m22: number\n    tX: number\n    tY: number\n}\n\nexport class Matrix implements MatrixStruct\n{\n    m11: number\n    m12: number\n    m21: number\n    m22: number\n    tX: number\n    tY: number\n    \n    constructor(matrix?: MatrixStruct) {\n        if (matrix === undefined) {\n            this.m11 = 1.0\n            this.m12 = 0.0\n            this.m21 = 0.0\n            this.m22 = 1.0\n            this.tX  = 0.0\n            this.tY  = 0.0\n        } else {\n            this.m11 = matrix.m11\n            this.m12 = matrix.m12\n            this.m21 = matrix.m21\n            this.m22 = matrix.m22\n            this.tX  = matrix.tX\n            this.tY  = matrix.tY\n        }\n    }\n    \n    identity() {\n        this.m11 = 1.0\n        this.m12 = 0.0\n        this.m21 = 0.0\n        this.m22 = 1.0\n        this.tX  = 0.0\n        this.tY  = 0.0\n    }\n    \n    append(matrix: Matrix) {\n        let n11 = this.m11 * matrix.m11 + this.m12 * matrix.m21\n        let n12 = this.m11 * matrix.m12 + this.m12 * matrix.m22\n        let n21 = this.m21 * matrix.m11 + this.m22 * matrix.m21\n        let n22 = this.m21 * matrix.m12 + this.m22 * matrix.m22\n        let nX  = this.tX  * matrix.m11 + this.tY  * matrix.m21 + matrix.tX\n        let nY  = this.tX  * matrix.m12 + this.tY  * matrix.m22 + matrix.tY\n        \n        this.m11 = n11\n        this.m12 = n12\n        this.m21 = n21\n        this.m22 = n22\n        this.tX  = nX\n        this.tY  = nY\n    }\n\n    prepend(matrix: Matrix) {\n        let n11 = matrix.m11 * this.m11 + matrix.m12 * this.m21\n        let n12 = matrix.m11 * this.m12 + matrix.m12 * this.m22\n        let n21 = matrix.m21 * this.m11 + matrix.m22 * this.m21\n        let n22 = matrix.m21 * this.m12 + matrix.m22 * this.m22\n        let nX  = matrix.tX  * this.m11 + matrix.tY  * this.m21 + this.tX\n        let nY  = matrix.tX  * this.m12 + matrix.tY  * this.m22 + this.tY\n        \n        this.m11 = n11\n        this.m12 = n12\n        this.m21 = n21\n        this.m22 = n22\n        this.tX  = nX\n        this.tY  = nY\n    }\n    \n    invert() {\n        let d = 1.0 / (this.m11 * this.m22 - this.m21 * this.m12)\n        let n11 = d *  this.m22\n        let n12 = d * -this.m12\n        let n21 = d * -this.m21\n        let n22 = d *  this.m11\n        let nX  = d * (this.m21 * this.tY - this.m22 * this.tX)\n        let nY  = d * (this.m12 * this.tX - this.m11 * this.tY)\n\n        this.m11 = n11\n        this.m12 = n12\n        this.m21 = n21\n        this.m22 = n22\n        this.tX  = nX\n        this.tY  = nY\n    }\n    \n    translate(point: Point) {\n        let m = new Matrix({\n            m11: 1.0, m12: 0.0,\n            m21: 0.0, m22: 1.0,\n            tX: point.x, tY: point.y\n        })\n        this.append(m)\n    }\n\n    rotate(radiant: number) {\n        let m = new Matrix({\n            m11:  Math.cos(radiant), m12: Math.sin(radiant),\n            m21: -Math.sin(radiant), m22: Math.cos(radiant),\n            tX: 0, tY: 0\n        })\n        this.append(m)\n    }\n    \n    scale(x: number, y:number) {\n        let m = new Matrix({\n            m11:  x, m12: 0,\n            m21:  0, m22: y,\n            tX: 0, tY: 0\n        })\n        this.append(m)\n    }\n    \n    transformPoint(point: Point): Point {\n        return {\n            x: point.x * this.m11 + point.y * this.m21 + this.tX,\n            y: point.x * this.m12 + point.y * this.m22 + this.tY\n        }\n    }\n\n    transformArrayPoint(point: [number, number]): [number, number] {\n        return [\n            point[0] * this.m11 + point[1] * this.m21 + this.tX,\n            point[0] * this.m12 + point[1] * this.m22 + this.tY\n        ]\n    }\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { Signal } from \"./signal\"\n\nexport abstract class Model {\n  modified: Signal\n  \n  constructor() {\n    this.modified = new Signal()\n  }\n  \n//  abstract set value(value: any)\n//  abstract get value(): any\n}\n\nexport class GenericModel<T> extends Model {\n  _value: T\n\n  constructor(value: T) {\n    super()\n    this._value = value\n  }\n  \n  set value(value: T) {\n    if (this._value == value)\n      return\n    this._value = value\n    this.modified.trigger()\n  }\n  \n  get value(): T {\n    return this._value\n  }\n}\n\nexport class TextModel extends Model {\n  _value: string|Function\n\n  constructor(value: string) {\n    super()\n    this._value = value\n  }\n  \n  set promise(promise: Function) {\n    this._value = promise\n    this.modified.trigger()\n  }\n  \n  get promise(): Function {\n    if (typeof this._value === \"string\") {\n      return () => {\n        return this._value\n      }\n    }\n    return this._value\n  }\n  \n  set value(value: string) {\n    if (this._value == value)\n      return\n    this._value = value\n    this.modified.trigger()\n  }\n  \n  get value(): string {\n    if (typeof this._value === \"number\") {\n      this._value = String(this._value)\n    } else\n    if (typeof this._value !== \"string\") {\n      this._value = this._value() as string\n    }\n    return this._value\n  }\n}\n\nexport class HtmlModel extends TextModel {\n  constructor(value: string) {\n    super(value)\n  }\n}\n\nexport class NumberModel extends GenericModel<number> {\n  min?: number\n  max?: number\n  step?: number\n  \n  constructor(value: number, options: any) {\n    super(value)\n    if (options) {\n      this.min = options.min\n      this.max = options.max\n      this.step = options.step\n    }\n  }\n}\n\nexport class BooleanModel extends GenericModel<boolean> {\n  constructor(value: boolean) {\n    super(value)\n  }\n}\n\nexport class OptionModelBase extends Model {\n    private _stringValue: string\n    \n    constructor() {\n        super()\n        this._stringValue = \"\"\n    }\n    \n    set stringValue(v: string) {\n        if (this._stringValue === v)\n            return\n        this._stringValue = v\n        this.modified.trigger()\n    }\n    \n    get stringValue() {\n        return this._stringValue\n    }\n    \n    isValidStringValue(stringValue: string): boolean {\n        return false\n    }\n}\n\nexport class OptionModel<T> extends OptionModelBase {\n    private _map: Map<string, T>\n\n    constructor() {\n        super()\n        this._map = new Map<string, T>()\n    }\n\n    add(id: string, value: T) {\n        this._map.set(id, value)\n    }\n\n    isValidStringValue(stringValue: string): boolean {\n        return this._map.has(stringValue)\n    }\n\n    get value(): T {\n        return this._map.get(this.stringValue)!\n    }\n\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nexport class SignalLink {\n  callback: (data?: any) => void\n  id?: any\n  constructor(callback: (data?: any) => void, id?: any) {\n    this.callback = callback\n    this.id = id\n  }\n}\n\n// TODO: specify the callback argument via generic\nexport class Signal {\n  locked?: boolean\n  triggered?: any\n  callbacks?: Array<SignalLink>\n\n  add(callback: (data?: any) => void): void\n  add(callback: (data?: any) => void, id: any): void\n  add(callback: (data?: any) => void, id?: any) {\n    if (!this.callbacks)\n      this.callbacks = new Array<SignalLink>()\n    this.callbacks.push(new SignalLink(callback, id))\n  }\n\n  remove(id: any) {\n    if (!this.callbacks)\n      return\n    for(let i=this.callbacks.length-1; i>=0; --i) {\n      if (this.callbacks[i].id === id)\n        this.callbacks.splice(i, 1)\n    }\n  }\n  \n  count(): number {\n    if (!this.callbacks)\n      return 0\n    return this.callbacks.length\n  }\n  \n  lock(): void {\n    this.locked = true\n  }\n  \n  unlock(): void {\n    this.locked = undefined\n    if (this.triggered) {\n      let data = this.triggered.data\n      this.triggered = undefined\n      this.trigger(data)\n    }\n  }\n\n  trigger(data?: any): void {\n    if (this.locked) {\n      this.triggered = { data: data }\n      return\n    }\n    if (!this.callbacks)\n      return\n\n    for(let i=0; i<this.callbacks.length; ++i)\n      this.callbacks[i].callback(data)\n  }\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n// utility functions to easy working with SVG\n\nexport function line(x1: number, y1: number, x2: number, y2: number): SVGLineElement {\n    const node = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\")\n    node.setAttributeNS(\"\", \"stroke\", \"#000\")\n    node.setAttributeNS(\"\", \"x1\", `${x1}`)\n    node.setAttributeNS(\"\", \"y1\", `${y1}`)\n    node.setAttributeNS(\"\", \"x2\", `${x2}`)\n    node.setAttributeNS(\"\", \"y2\", `${y2}`)\n    return node\n}\n\nexport function rectangle(x: number, y: number, width: number, height: number): SVGRectElement {\n    const node = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\")\n    node.setAttributeNS(\"\", \"stroke\", \"#000\")\n    node.setAttributeNS(\"\", \"fill\", \"none\")\n    node.setAttributeNS(\"\", \"x\", `${x}`)\n    node.setAttributeNS(\"\", \"y\", `${y}`)\n    node.setAttributeNS(\"\", \"width\", `${width}`)\n    node.setAttributeNS(\"\", \"height\", `${height}`)\n    return node\n}\n\nexport function circle(cx: number, cy: number, r: number): SVGCircleElement {\n    const node = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\")\n    node.setAttributeNS(\"\", \"stroke\", \"#000\")\n    node.setAttributeNS(\"\", \"cx\", `${cx}`)\n    node.setAttributeNS(\"\", \"cy\", `${cy}`)\n    node.setAttributeNS(\"\", \"r\", `${r}`)\n    return node\n}\n\nexport function text(x: number, y: number, text: string): SVGTextElement {\n    const node = document.createElementNS(\"http://www.w3.org/2000/svg\", \"text\")\n    node.setAttributeNS(\"\", \"fill\", \"#000\")\n    node.setAttributeNS(\"\", \"x\", `${x}`)\n    node.setAttributeNS(\"\", \"y\", `${y}`)\n    node.appendChild(document.createTextNode(text))\n    node.style.pointerEvents = \"none\"\n    return node\n}","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { TextModel } from \"../model\"\nimport { View } from \"../view\"\nimport { TextView } from \"../view/text\"\nimport { TableModel } from \"./TableModel\"\n\nexport class ArrayTableModel extends TableModel {\n\n  data: any\n\n  constructor(data: any) {\n    super()\n    this.data = data\n  }\n\n  get colCount(): number { return this.data ? this.data[0].length : 0 }\n  get rowCount(): number { return this.data ? this.data.length : 0 }\n\n  getColumnHead(column: number): TextModel {\n    switch (column) {\n      case 0: return new TextModel(\"Title\")\n      case 1: return new TextModel(\"Author\")\n      case 2: return new TextModel(\"Year\")\n    }\n    throw Error(\"fuck\")\n  }\n\n  getFieldModel(col: number, row: number): TextModel {\n    let model = new TextModel(this.data[row][col])\n    model.modified.add(() => {\n      this.data[row][col] = model.value\n    })\n    return model\n  }\n\n  getFieldView(col: number, row: number): View {\n    return new TextView()\n  }\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { Model } from \"../model\"\nimport { TableEditMode, TablePos } from \"./table\"\n\n// FIXME: also needed is a model for range and 'random' selections\n\nexport class SelectionModel extends Model {\n  mode: TableEditMode // FIXME: there might be a way to do without, just by the behaviour of a common API towards TableView\n  _value: TablePos\n\n  constructor() {\n    super()\n    this.mode = TableEditMode.SELECT_ROW\n    this._value = new TablePos(0, 0)\n  }\n\n  set col(col: number) {\n    if (this._value.col === col)\n      return\n    this._value.col = col\n    this.modified.trigger()\n  }\n\n  get col(): number {\n    return this._value.col\n  }\n\n  set row(row: number) {\n    if (this._value.row === row)\n      return\n    this._value.row = row\n    this.modified.trigger()\n  }\n\n  get row(): number {\n    return this._value.row\n  }\n\n  set value(value: TablePos) {\n    if (this._value.col === value.col && this._value.row === value.row)\n      return\n    this._value = value\n    this.modified.trigger()\n  }\n\n  get value(): TablePos {\n    return this._value\n  }\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { Model, TextModel } from \"../model\"\nimport { View } from \"../view\"\n\n// FIXME: API for insert, delete and move row(s)\n\nexport abstract class TableModel extends Model {\n  abstract get colCount(): number\n  abstract get rowCount(): number\n  isEmpty() { return this.colCount === 0 && this.rowCount === 0 }\n\n  // TODO: not sure about these\n  getColumnHead(column: number): TextModel | undefined { return undefined }\n  abstract getFieldModel(col: number, row: number): TextModel\n  getFieldView(col: number, row: number): View | undefined { return undefined }\n}\n\n\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport * as dom from \"../dom\"\nimport { Model, TextModel, HtmlModel } from \"../model\"\nimport { GenericView } from \"../view\"\nimport { TableModel } from \"./TableModel\"\nimport { SelectionModel } from \"./SelectionModel\"\nimport { TableEditMode, TablePos } from \"./table\"\n\nfunction pixelToNumber(pixel: string): number {\n    if (pixel.substr(pixel.length - 2) !== \"px\")\n        throw Error(\"expected 'px' suffix\")\n    return Number.parseFloat(pixel.substr(0, pixel.length - 2))\n}\n\nfunction getPropertyValue(element: HTMLElement, propertyName: string): number {\n    let elementStyle = window.getComputedStyle(element, undefined)\n    let property = elementStyle.getPropertyValue(propertyName)\n    return pixelToNumber(property)\n}\n\nfunction horizontalPadding(element: HTMLElement): number {\n    return getPropertyValue(element, \"padding-left\") + getPropertyValue(element, \"padding-right\")\n}\n\nlet tableStyle = document.createElement(\"style\")\ntableStyle.textContent=`\n.t2 {\n  /* border: 1px inset; */\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  outline-offset: -2px;\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n}\n\n.t2h, .t2d {\n  border-color: #ccc #fff #fff #ccc;\n  border-width: 2px 0px 0px 2px;\n  border-style: solid none none solid;\n  border-collapse: collapse;\n  border-spacing: 0;\n}\n\n/* FIXME: there is no re-evaluation after the table view was resized */\n/*\nth:last-child, td:last-child {\n  width: 100%;\n}\n*/\n\n.t2h tr {\n  background: #e0e0e0;\n}\n\n.t2h * th {\n  border-color: #fff #ccc #ccc #fff;\n  border-style: none solid none none;\n  border-width: 0 1px 0 0;\n  z-index: 1;\n  letter-spacing: 0;  \n  overflow: hidden;   \n  padding: 2px;\n  margin: 0px; \n  white-space: nowrap;\n}\n \n.t2d * td {\n  border-color: #fff #ccc #ccc #fff;\n  border-style: none solid solid none;\n  border-width: 0 1px 1px 0;\n  letter-spacing: 0;\n  overflow: hidden; \n  padding: 2px;\n  margin: 0px; \n  white-space: nowrap;\n  /* background: #fff; */\n}\n\n.t2d tr:nth-child(even) {\n  background: var(--toad-table-even-row, #f5f5f5);\n}\n.t2d tr:nth-child(odd) {\n  background: var(--toad-table-odd-row, #ffffff);\n}\n\ndiv .t2d tr.selected,\ndiv .t2d tr td.selected {\n/*\n  background: #dcdcdc;\n  color: #000;\n*/\n  background: #808080;\n  color: #fff;\n}\n\n.t2:focus .t2d tr.selected,\n.t2:focus .t2d tr td.selected {\n  background: #0069d4;\n  color: #fff;\n}\n`\n\nexport let treeStyle = document.createElement(\"style\")\ntreeStyle.textContent=`\n.t2 {\n  /* border: 1px inset; */\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  outline-offset: -2px;\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n}\n\n.t2h, .t2d {\n  border-color: #ccc #fff #fff #ccc;\n  border-width: 2px 0px 0px 2px;\n  border-style: solid none none solid;\n  border-collapse: collapse;\n  border-spacing: 0;\n}\n\n/* FIXME: there is no re-evaluation after the table view was resized */\n/*\nth:last-child, td:last-child {\n  width: 100%;\n}\n*/\n\n.t2h tr {\n  background: #e0e0e0;\n}\n\n.t2h * th {\n  border-color: none;\n  border-style: none;\n  border-width: 0;\n  z-index: 1;\n  letter-spacing: 0;  \n  overflow: hidden;   \n  padding: 0px;\n  margin: 0px; \n  white-space: nowrap;\n}\n\n.t2d * td {\n  border-color: none;\n  border-style: none;\n  border-width: 0;\n  letter-spacing: 0;\n  overflow: hidden; \n  padding: 0px;\n  margin: 0px; \n  white-space: nowrap;\n  /* background: #fff; */\n}\n\n.t2d tr:nth-child(even) {\n  background: var(--toad-table-even-row, #f5f5f5);\n}\n.t2d tr:nth-child(odd) {\n  background: var(--toad-table-odd-row, #ffffff);\n}\n\ndiv .t2d tr.selected,\ndiv .t2d tr td.selected {\n/*\n  background: #dcdcdc;\n  color: #000;\n*/\n  background: #808080;\n  color: #fff;\n}\n\n.t2:focus .t2d tr.selected,\n.t2:focus .t2d tr td.selected {\n  background: #0069d4;\n  color: #fff;\n}\n`\n\n/*\n * no row headers yet\n *\n * rootDiv (div.t2, onkeydown)\n *   headDiv (div, hidden)\n *     headTable (table.t2h)\n *       headHead (thead)\n *         headRow (tr)\n *   bodyDiv (div, onscroll)\n *     bodyTable (table.t2d)\n *       bodyBody (tbody)\n *         bodyRow (tr)\n *     zeroSize (div)\n *       inputDiv (div, focusin) ->\n */\n\nexport class TableView extends GenericView<TableModel> {\n\n  selectionModel?: SelectionModel\n\n  rootDiv: HTMLDivElement\n  headTable: HTMLTableElement\n  headRow: HTMLTableRowElement\n  bodyRow: HTMLTableRowElement\n  bodyDiv: HTMLDivElement\n  bodyBody: HTMLTableSectionElement\n\n  inputDiv: HTMLElement\n  fieldView?: HTMLElement\n  fieldModel?: Model\n  cellBeingEdited?: HTMLElement\n  insideGoTo: boolean\n\n  constructor() {\n    super()\n\n    this.insideGoTo = false\n\n    this.rootDiv = document.createElement(\"div\")\n    this.rootDiv.className = \"t2\"\n\n    this.rootDiv.onkeydown = (event: KeyboardEvent) => {\n      if (!this.selectionModel)\n        return\n      // FIXME: based on the selection model we could plug in a behaviour class\n      switch (this.selectionModel.mode) {\n        case TableEditMode.SELECT_ROW: {\n          let row = this.selectionModel.value.row\n          switch (event.key) {\n            case \"ArrowDown\":\n              if (row + 1 < this.model!.rowCount)\n                ++row\n              break\n            case \"ArrowUp\":\n              if (row > 0)\n                --row\n              break\n          }\n          if (row != this.selectionModel.value.row) {\n            this.toggleRowSelection(this.selectionModel.value.row, false)\n            this.selectionModel.row = row\n            this.toggleRowSelection(this.selectionModel.value.row, true)\n          }\n        } break\n        case TableEditMode.SELECT_CELL: {\n          let pos = { col: this.selectionModel.col, row: this.selectionModel.row }\n          switch (event.key) {\n            case \"ArrowRight\":\n              if (pos.col + 1 < this.model!.colCount) {\n                ++pos.col\n              }\n              break\n            case \"ArrowLeft\":\n              if (pos.col > 0) {\n                --pos.col\n              }\n              break\n            case \"ArrowDown\":\n              if (pos.row + 1 < this.model!.rowCount)\n                ++pos.row\n              break\n            case \"ArrowUp\":\n              if (pos.row > 0)\n                --pos.row\n              break\n          }\n          if (pos.col != this.selectionModel.col ||\n            pos.row != this.selectionModel.row) {\n            this.toggleCellSelection(this.selectionModel.value, false)\n            this.selectionModel.value = pos\n            this.toggleCellSelection(this.selectionModel.value, true)\n          }\n        } break\n      }\n    }\n\n    // head\n    let headDiv = document.createElement(\"div\")\n    // headDiv.style.width = \"1px\"\n    headDiv.style.overflow = \"hidden\"\n\n    let headTable = document.createElement(\"table\")\n    this.headTable = headTable\n    headTable.className = \"t2h\"\n\n    let headHead = document.createElement(\"thead\")\n\n    let headRow = document.createElement(\"tr\")\n    this.headRow = headRow\n\n    headHead.appendChild(headRow)\n    headTable.appendChild(headHead)\n    headDiv.appendChild(headTable)\n    this.rootDiv.appendChild(headDiv)\n\n    // body\n    let bodyDiv = document.createElement(\"div\")\n    // headDiv.style.width = \"1px\"\n    bodyDiv.style.overflow = \"auto\"\n    bodyDiv.onscroll = function () {\n      headDiv.scrollLeft = bodyDiv.scrollLeft\n    }\n    this.bodyDiv = bodyDiv\n\n    let bodyTable = document.createElement(\"table\")\n    bodyTable.className = \"t2d\"\n    bodyTable.onmousedown = (event: MouseEvent) => {\n      if (!event.srcElement)\n        return\n      if ((event.srcElement as HTMLElement).tagName !== \"TD\")\n        return\n      event.preventDefault() // otherwise field will loose focus again\n      this.goToField(event.srcElement as HTMLTableDataCellElement)\n    }\n\n    let bodyBody = document.createElement(\"tbody\")\n    this.bodyBody = bodyBody\n\n    let bodyRow = document.createElement(\"tr\")\n    this.bodyRow = bodyRow\n\n    bodyBody.appendChild(bodyRow)\n    bodyTable.appendChild(bodyBody)\n    bodyDiv.appendChild(bodyTable)\n\n    let zeroSize = document.createElement(\"div\")\n    zeroSize.style.width = \"0px\"\n    zeroSize.style.height = \"0px\"\n    zeroSize.style.margin = \"0\"\n    zeroSize.style.padding = \"0\"\n    zeroSize.style.border = \"none\"\n\n    this.inputDiv = document.createElement(\"div\")\n    this.inputDiv.style.position = \"relative\"\n    this.inputDiv.style.background = \"#fff\"\n    this.inputDiv.style.border = \"none\"\n    this.inputDiv.style.opacity = \"0\"\n\n    this.inputDiv.addEventListener(\"focusin\", (genericEvent: Event) => {\n      this.inputDiv.style.opacity = \"1\"\n      if (this.insideGoTo)\n        return\n      if (!this.model)\n        return\n      let event = genericEvent as FocusEvent\n      if (event.target && event.relatedTarget) {\n        if (dom.order(event.relatedTarget as Node, this)) {\n          this.goTo(0, 0)\n        } else {\n          this.goTo(this.model.colCount - 1, this.model.rowCount - 1)\n        }\n      }\n    })\n    this.inputDiv.addEventListener(\"focusout\", () => {\n      this.inputDiv.style.opacity = \"0\"\n    })\n\n    zeroSize.appendChild(this.inputDiv)\n    bodyDiv.appendChild(zeroSize)\n    this.rootDiv.appendChild(bodyDiv)\n\n    this.attachShadow({ mode: 'open' })\n    this.shadowRoot!.appendChild(document.importNode(treeStyle, true))\n    this.shadowRoot!.appendChild(this.rootDiv)\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    this.bodyDiv.style.height = this.style.height // FIXME: include heading\n  }\n\n  setModel(model?: Model): void {\n    if (!model) {\n      if (this.selectionModel)\n        this.selectionModel.modified.remove(this)\n      this.model = undefined\n      this.selectionModel = new SelectionModel()\n      this.updateView()\n      return\n    }\n\n    if (model instanceof SelectionModel) {\n      this.selectionModel = model\n      this.updateSelection()\n      this.selectionModel.modified.add(() => {\n        this.updateSelection()\n      }, this)\n    }\n    else if (model instanceof TableModel) {\n      this.model = model\n      this.updateView()\n    } else {\n      throw Error(\"unexpected model of type \" + model.constructor.name)\n    }\n  }\n\n  updateModel() {\n    //console.log(\"TableView.updateModel()\")\n    //    if (this.model)\n    //      this.model.value = this.input.value\n  }\n\n  updateView() {\n    //console.log(\"TableView.updateView()\")\n    if (!this.model) {\n      return\n    }\n\n    //console.log(\"updateHeader, updateBody\")\n    this.updateHeader()\n    this.updateBody()\n    this.updateSelection()\n    setTimeout(() => {\n      this.adjustInternalTables()\n    })\n  }\n\n  updateHeader() {\n    if (!this.model)\n      throw Error(\"fuck\")\n\n    let noHeader = false\n\n    while (this.headRow.children.length > this.model.colCount + 1)\n      this.headRow.removeChild(this.headRow.children[this.headRow.children.length - 1])\n\n    for (let i = 0; i < this.model.colCount; ++i) {\n      let cell\n      if (i >= this.headRow.children.length) {\n        cell = dom.tag(\"th\")\n        this.headRow.appendChild(cell)\n      } else {\n        cell = this.headRow.children[i] as HTMLTableDataCellElement\n        cell.style.minWidth = \"\"\n        cell.style.border = \"\"\n      }\n      let text = this.model.getColumnHead(i)\n      if (text === undefined) {\n        noHeader = true\n        continue\n      }\n      if (text instanceof HtmlModel)\n        cell.innerHTML = text.value\n\n      else\n        cell.innerText = text.value\n    }\n\n    let fillerForMissingScrollbar\n    if (this.headRow.children.length < this.model.colCount + 1) {\n      fillerForMissingScrollbar = dom.tag(\"th\") as HTMLTableDataCellElement\n      this.headRow.appendChild(fillerForMissingScrollbar)\n    } else {\n      fillerForMissingScrollbar = this.headRow.children[this.headRow.children.length - 1] as HTMLTableDataCellElement\n    }\n    fillerForMissingScrollbar.innerText = \"\"\n    fillerForMissingScrollbar.style.minWidth = \"777px\"\n    fillerForMissingScrollbar.style.border = \"0px none\"\n\n    this.headTable.style.display = noHeader ? \"none\" : \"\"\n  }\n\n  updateBody() {\n    if (!this.model)\n      throw Error(\"fuck\")\n\n    while (this.bodyRow.children.length > this.model.colCount)\n      this.bodyRow.removeChild(this.bodyRow.children[this.bodyRow.children.length - 1])\n\n    while (this.bodyRow.children.length < this.model.colCount) {\n      let cell = dom.tag(\"td\")\n      cell.style.paddingTop = \"0\"\n      cell.style.paddingBottom = \"0\"\n      this.bodyRow.appendChild(cell)\n    }\n    //    (this.bodyRow.children[this.bodyRow.children.length] as HTMLElement).style.width=\"100%\"\n    while (this.bodyBody.children.length - 1 > this.model.rowCount)\n      this.bodyBody.removeChild(this.bodyBody.children[this.bodyBody.children.length - 1])\n\n    for (let row = 0; row < this.model.rowCount; ++row) {\n      let bodyRow: HTMLTableRowElement\n      if (row + 1 >= this.bodyBody.children.length) {\n        bodyRow = document.createElement(\"tr\")\n        this.bodyBody.appendChild(bodyRow)\n      } else {\n        bodyRow = this.bodyBody.children[row + 1] as HTMLTableRowElement\n      }\n\n      while (bodyRow.children.length > this.model.colCount)\n        bodyRow.removeChild(bodyRow.children[bodyRow.children.length - 1])\n\n      for (let col = 0; col < this.model.colCount; ++col) {\n        let cell: HTMLTableDataCellElement\n        if (col >= bodyRow.children.length) {\n          cell = document.createElement(\"td\")\n          bodyRow.appendChild(cell)\n        } else {\n          cell = bodyRow.children[col] as HTMLTableDataCellElement\n        }\n        cell.style.width = \"\"\n        let fieldModel = this.model.getFieldModel(col, row)\n        //console.log(\"  updateBody. cell \"+col+\", \"+row+\" = '\"+fieldModel.value+\"'\")\n        if (cell.innerText != fieldModel.value) {\n          //          if (cell.innerText != \"\")\n          //            throw Error(\"TableView.updateBody(): cell \"+col+\", \"+row+\" differs during update, old='\" + cell.innerText + \"', new='\" + fieldModel.value + \"'\")\n          if (fieldModel instanceof HtmlModel)\n            cell.innerHTML = fieldModel.value\n\n          else if (fieldModel instanceof TextModel)\n            cell.innerText = fieldModel.value\n          else {\n            cell.appendChild(this.model.getFieldView(col, row)!)\n          }\n        }\n      }\n\n      if (this.style.width === \"100%\") {\n        let lastCell = bodyRow.children[bodyRow.children.length - 1] as HTMLTableDataCellElement\n        lastCell.style.width = \"100%\"\n      }\n\n    }\n    //    dump(this.bodyBody)\n  }\n\n  updateSelection() {\n    if (this.selectionModel === undefined)\n      return\n\n    switch (this.selectionModel.mode) {\n      case TableEditMode.EDIT_CELL:\n        this.prepareFieldAtPosition(this.selectionModel.col, this.selectionModel.row)\n        delete this.rootDiv.tabIndex\n        break\n      case TableEditMode.SELECT_CELL: {\n        let allSelected = this.bodyBody.querySelectorAll(\"tbody > tr > td.selected\")\n        for (let selected of allSelected)\n          selected.classList.remove(\"selected\")\n        this.toggleCellSelection(this.selectionModel.value, true)\n        this.rootDiv.tabIndex = 0\n        break\n      }\n      case TableEditMode.SELECT_ROW: {\n        let allSelected = this.bodyBody.querySelectorAll(\"tbody > tr.selected\")\n        for (let selected of allSelected)\n          selected.classList.remove(\"selected\")\n        this.toggleRowSelection(this.selectionModel.value.row, true)\n        this.rootDiv.tabIndex = 0\n        break\n      }\n    }\n  }\n\n  adjustInternalTables() {\n    let headRow = this.headRow.children\n    let bodyRow = this.bodyRow.children\n    for (let col = 0; col < this.model!.colCount; ++col) {\n      let head = headRow[col] as HTMLElement\n      let body = bodyRow[col] as HTMLElement\n\n      let headWidth = head.clientWidth - horizontalPadding(head)\n      let bodyWidth = body.clientWidth - horizontalPadding(body)\n\n      head.style.width = head.style.minWidth = head.style.maxWidth =\n        body.style.width = body.style.minWidth = body.style.maxWidth =\n        ((headWidth > bodyWidth ? headWidth : bodyWidth)) + \"px\"\n    }\n\n    if (this.style.width !== \"100%\")\n      this.rootDiv.style.width = (this.bodyRow.clientWidth + this.bodyDiv.offsetWidth - this.bodyDiv.clientWidth + 2) + \"px\"\n    //    this.rootElement.style.height = (this.bodyRow.clientHeight + this.bodyDiv.offsetHeight - this.bodyDiv.clientHeight + 2) + \"px\"\n  }\n\n  unadjustInternalTables(pos: any) {\n    let headRow = this.headRow.children\n    let bodyRow = this.bodyRow.children\n    let head = headRow[pos.col] as HTMLElement\n    let body = bodyRow[pos.col] as HTMLElement\n    head.style.width = head.style.minWidth = head.style.maxWidth =\n      body.style.width = body.style.minWidth = body.style.maxWidth = \"\"\n  }\n\n  toggleCellSelection(pos: TablePos, flag: boolean): void {\n    if (pos.col >= this.model!.colCount || pos.row >= this.model!.rowCount)\n      return\n    let element = this.bodyBody.children[pos.row + 1].children[pos.col]\n    element.classList.toggle(\"selected\", flag)\n    if (flag) {\n      // FIXME: only when we also have the focus\n      if (element.scrollIntoViewIfNeeded)\n        element.scrollIntoViewIfNeeded()\n\n      else\n        element.scrollIntoView()\n    }\n  }\n\n  toggleRowSelection(row: number, flag: boolean): void {\n    if (row >= this.model!.rowCount)\n      return\n    let rowElement = this.bodyBody.children[1 + this.selectionModel!.value.row]\n    rowElement.classList.toggle(\"selected\", flag)\n    if (flag) {\n      // FIXME: only when we also have the focus\n      if (rowElement.scrollIntoViewIfNeeded)\n        rowElement.scrollIntoViewIfNeeded()\n\n      else\n        rowElement.scrollIntoView()\n    }\n  }\n\n  adjustInputToElement(element: HTMLTableDataCellElement) {\n    let boundary = element.getBoundingClientRect()\n    let td = element\n    let tr = td.parentElement\n    let tbody = tr!.parentElement\n\n    if (navigator.userAgent.indexOf(\"Chrome\") > -1) {\n      // Chrome\n      this.inputDiv.style.left = (td.offsetLeft + 2) + \"px\"\n      this.inputDiv.style.top = (td.offsetTop - tbody!.clientHeight) + \"px\"\n    } else {\n      // Safari & Opera\n      this.inputDiv.style.left = (td.offsetLeft + 1) + \"px\"\n      this.inputDiv.style.top = (td.offsetTop - tbody!.clientHeight - 1) + \"px\"\n    }\n\n    let width = (element.clientWidth - horizontalPadding(element)) + \"px\"\n\n    this.inputDiv.style.width = width\n    this.inputDiv.style.height = (boundary.height) + \"px\"\n\n    // FIXME: add two new functions: lockElement(), unlockElement() and invoke the accordingly\n    // element.style.width = element.style.minWidth = element.style.maxWidth = width\n  }\n\n  goTo(column: number, row: number) {\n    this.insideGoTo = true\n    this.prepareFieldAtPosition(column, row)\n    this.focus()\n    this.insideGoTo = false\n  }\n\n  goToField(element: HTMLTableDataCellElement | undefined) {\n    this.insideGoTo = true\n    if (!element)\n      return\n    this.prepareFieldAtElement(element)\n    this.focus()\n    this.insideGoTo = false\n  }\n\n  focus() {\n    if (this.fieldView) {\n      this.fieldView.focus()\n    } else {\n      this.rootDiv.focus()\n    }\n  }\n\n  prepareFieldAtPosition(column: number, row: number) {\n    this.prepareFieldAtElement(this.getElementAt(column, row))\n  }\n\n  getElementAt(column: number, row: number): HTMLTableDataCellElement {\n    let element = this.bodyBody.children[row + 1].children[column] as HTMLTableDataCellElement\n    if (!element)\n      throw Error(\"fuck\")\n    return element\n  }\n\n  prepareFieldAtElement(element: HTMLTableDataCellElement | undefined) {\n    if (element === undefined || element.tagName !== \"TD\")\n      return\n\n    let pos = this.positionOfField(element)\n\n    if (this.selectionModel) {\n      switch (this.selectionModel.mode) {\n        case TableEditMode.EDIT_CELL:\n          this.selectionModel.value = pos\n          break\n        case TableEditMode.SELECT_CELL:\n          this.toggleCellSelection(this.selectionModel.value, false)\n          this.selectionModel.value = pos\n          this.toggleCellSelection(this.selectionModel.value, true)\n          return\n        case TableEditMode.SELECT_ROW:\n          this.toggleRowSelection(this.selectionModel!.value.row, false)\n          this.selectionModel.value.row = pos.row\n          this.toggleRowSelection(this.selectionModel!.value.row, true)\n          return\n      }\n    }\n\n    let fieldView = this.model!.getFieldView(pos.col, pos.row)\n    if (!fieldView)\n      return\n    this.fieldView = fieldView\n    fieldView.classList.add(\"embedded\")\n\n    let fieldModel = this.model!.getFieldModel(pos.col, pos.row)\n    fieldView.setModel(fieldModel)\n\n    /*\n        // adjust table size while editing (cursor handling is ugly)\n        fieldModel.modified.add( () => {\n          element.innerText = fieldModel.value\n          setTimeout( () => {\n            // apply element size to fieldView\n            this.adjustInputToElement(element)\n            this.adjustInternalTables()\n          }, 0)\n        })\n    */\n    fieldView.onblur = () => {\n      if (element.innerText == fieldModel.value)\n        return\n      element.innerText = fieldModel.value\n      this.unadjustInternalTables(pos)\n      setTimeout(() => {\n        this.adjustInternalTables()\n      }, 0)\n    }\n\n    fieldView.onkeydown = (event: KeyboardEvent) => {\n      switch (event.key) {\n        case \"ArrowDown\":\n          if (pos.row + 1 >= this.model!.rowCount)\n            break\n          event.preventDefault()\n          this.goTo(pos.col, pos.row + 1)\n          break\n        case \"ArrowUp\":\n          if (pos.row === 0)\n            break\n          event.preventDefault()\n          this.goTo(pos.col, pos.row - 1)\n          break\n        case \"Tab\":\n          if (event.shiftKey) {\n            if (pos.col > 0) {\n              event.preventDefault()\n              this.goTo(pos.col - 1, pos.row)\n            } else {\n              if (pos.row > 0) {\n                event.preventDefault()\n                this.goTo(this.model!.colCount - 1, pos.row - 1)\n              }\n            }\n          } else {\n            if (pos.col + 1 < this.model!.colCount) {\n              event.preventDefault()\n              this.goTo(pos.col + 1, pos.row)\n            } else {\n              if (pos.row + 1 < this.model!.rowCount) {\n                event.preventDefault()\n                this.goTo(0, pos.row + 1)\n              }\n            }\n          }\n          break\n      }\n\n    }\n\n    if (this.inputDiv.children.length === 0) {\n      this.inputDiv.appendChild(fieldView)\n    } else {\n      if (document.hasFocus() && document.activeElement === this) {\n        this.inputDiv.children[0].dispatchEvent(new FocusEvent(\"blur\"))\n      }\n      this.inputDiv.replaceChild(fieldView, this.inputDiv.children[0])\n    }\n\n    this.adjustInputToElement(element)\n  }\n\n  positionOfField(element: HTMLElement): TablePos {\n    let col: number, row: number\n    for (col = 0; col < this.model!.colCount; ++col) {\n      if (element.parentElement!.children[col] === element)\n        break\n    }\n    for (row = 1; row < this.model!.rowCount + 1; ++row) {\n      if (element.parentElement!.parentElement!.children[row] === element.parentElement)\n        break\n    }\n    --row\n    return new TablePos(col, row)\n  }\n}\n\nwindow.customElements.define(\"toad-table\", TableView)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { TableModel } from \"./TableModel\"\n\nexport abstract class TypedTableModel<T> extends TableModel {\n    nodeClass: new () => T\n    constructor(nodeClass: new () => T, root?: T) {\n        super()\n        this.nodeClass = nodeClass\n    }\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { TableModel } from \"./TableModel\"\nimport { ArrayTableModel } from \"./ArrayTableModel\"\n\nfunction dump(element: HTMLElement, depth?: number): void {\n  if (depth===undefined)\n    depth = 0\n  let out=\"\"\n  for(let i=0; i<depth; ++i)\n    out += \"  \"\n  out += element.tagName\n  if (element.tagName===\"TD\" || element.tagName===\"TH\")\n    out+=\"  '\" + element.innerText + \"'\"\n  console.log(out)\n  for(let child of element.children)\n    dump(child as HTMLElement, depth+1)\n}\n\ndeclare global {\n  interface Element {\n    scrollIntoViewIfNeeded(center?: boolean): void\n  }\n}\n\nexport enum TableEditMode {\n  EDIT_CELL, // FIXME: replace with SELECT_CELL and TableModel.getFieldView will return undefined when not editable\n  SELECT_CELL,\n//  SELECT_COLUMN,\n  SELECT_ROW\n}\n\nexport class TablePos {\n  col: number\n  row: number\n  constructor(col: number, row: number) {\n    this.col = col\n    this.row = row\n  }\n}\n\nlet tableModelLocators = new Array<(data: any) => TableModel|undefined>()\n\nexport function registerTableModelLocator( locator: (data: any) => TableModel|undefined ): void {\n  tableModelLocators.push(locator)\n}\n\nexport function createTableModel(data: any): TableModel {\n  for(let locator of tableModelLocators) {\n    let model = locator(data)\n    if (model)\n      return model\n  }\n  throw new Error(\"findTableModel() failed to locate a table model\")\n}\n\nregisterTableModelLocator( function(data: any): TableModel | undefined {\n  if (!(data instanceof Array)) {\n    return undefined\n  }\n  if (data.length===0) {\n    return undefined\n  }\n  if (!(data[0] instanceof Array)) {\n    return undefined\n  }\n  for(let field of data[0]) {\n    if ( typeof field !== \"string\" &&\n         typeof field !== \"number\" )\n    {\n      return undefined\n    }\n  }\n  return new ArrayTableModel(data)\n})\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { TextModel, View, Model, bind } from '../toad'\nimport { TypedTableModel } from \"./TypedTableModel\"\nimport { text, line, rectangle } from \"../svg\"\n\nexport enum TableEventType {\n    // Model Messages (generated by model)\n    INSERT_ROW, REMOVED_ROW,\n    INSERT_COL, REMOVED_COL,\n    CONTENT, // content was modified, but no row/cols added/removed\n\n    // TableAdapter messages (not generated by models)\n    RESIZED_ROW, RESIZED_COL,\n    CHANGED, // new model\n}\n\nexport class TableEvent {\n    type: TableEventType\n    index: number\n    size: number\n    constructor(type: TableEventType, index: number, size: number) {\n        this.type = type\n        this.index = index\n        this.size = size\n    }\n}\n\nexport abstract class TreeModel<T> extends TypedTableModel<T> {\n\n    constructor(nodeClass: new() => T) {\n        super(nodeClass)\n        this.rows = new Array<TreeModel.Row<T>>()\n    }\n\n    get colCount(): number { return 1 }\n    get rowCount(): number { return this.rows.length }\n\n    addSiblingBefore(row: number): number {\n        const nn = this.createNode()\n        if (this.rows.length === 0) { // TODO: can we remove this?\n            row = 0\n            this.setRoot(nn)\n            this.rows.push(new TreeModel.Row(nn, 0))\n        } else {\n            if (row === 0) {\n                this.setNext(nn, this.getRoot())\n                this.setRoot(nn)\n                this.rows.unshift(new TreeModel.Row(nn, 0))\n            } else {\n                this.setNext(nn, this.rows[row].node)\n                if (this.getNext(this.rows[row-1].node) === this.rows[row].node)\n                    this.setNext(this.rows[row-1].node, nn)\n                else\n                    this.setDown(this.rows[row-1].node, nn)\n                this.rows.splice(row, 0, new TreeModel.Row(nn, this.rows[row].depth))\n            }            \n        }\n        this.modified.trigger(new TableEvent(TableEventType.INSERT_ROW, row, 1))\n        return row\n    }\n\n    addSiblingAfter(row: number): number {\n        const nn = this.createNode()\n        if (this.rows.length === 0) {\n            row = 0\n            this.setRoot(nn)\n            this.rows.push(new TreeModel.Row(nn, 0))\n        } else {\n            this.setNext(nn, this.getNext(this.rows[row].node))\n            this.setNext(this.rows[row].node, nn)\n\n            const count = this.nodeCount(this.getDown(this.rows[row].node))\n            // console.log(`addSiblingAfter: subtree has ${count} nodes`)\n            const depth = this.rows[row].depth\n            row += count + 1\n            this.rows.splice(row, 0, new TreeModel.Row(nn, depth))\n        }\n        this.modified.trigger(new TableEvent(TableEventType.INSERT_ROW, row, 1))\n        return row\n    }\n\n    addChildAfter(row: number): number {\n        const nn = this.createNode()\n        if (this.rows.length === 0) {\n            this.setRoot(nn)\n            this.rows.push(new TreeModel.Row(nn, 0))\n            this.modified.trigger(new TableEvent(TableEventType.INSERT_ROW, 0, 1))\n        } else {\n            const down = this.getDown(this.rows[row].node)\n\n            const subtreeSize = this.nodeCount(down)\n            // console.log(`subtreeSize = ${subtreeSize}`)\n            for(let i=0; i<subtreeSize; ++i)\n                 ++this.rows[row+1+i].depth\n\n            this.setDown(nn, down)\n            this.setDown(this.rows[row].node, nn)\n\n            this.rows.splice(row+1, 0, new TreeModel.Row(nn, this.rows[row].depth + 1))\n            this.modified.trigger(new TableEvent(TableEventType.INSERT_ROW, row + 1, 1))\n        }\n        return row\n    }\n\n    addParentBefore(row: number): number {\n        const nn = this.createNode()\n        if (row === 0) {\n            for(let i=0; i<this.rows.length; ++i)\n                 ++this.rows[row+i].depth\n            this.setDown(nn, this.getRoot())\n            this.setRoot(nn)\n            this.rows.unshift(new TreeModel.Row(nn, 0))\n        } else {\n            const depth = this.rows[row].depth\n            const subtreeSize = this.nodeCount(this.getDown(this.rows[row].node)) + 1\n            // console.log(`row = ${row}, this.rows.length=${this.rows.length}, subtreeSize = ${subtreeSize}`)\n            for(let i=0; i<subtreeSize; ++i)\n                 ++this.rows[row+i].depth\n\n            this.setDown(nn, this.rows[row].node)\n            this.setNext(nn, this.getNext(this.rows[row].node))\n\n            this.setNext(this.rows[row].node, undefined)\n            if (this.getNext(this.rows[row-1].node) === this.rows[row].node)\n                this.setNext(this.rows[row-1].node, nn)\n            else\n                this.setDown(this.rows[row-1].node, nn)\n            this.rows.splice(row, 0, new TreeModel.Row(nn, depth))\n        }\n        this.modified.trigger(new TableEvent(TableEventType.INSERT_ROW, row, 1))\n        return row\n    }\n    \n    deleteAt(row: number): number {\n        let down = this.getDown(this.rows[row].node)\n        if (down !== undefined) {\n            // move child to current position\n\n            const subtreeSize = this.nodeCount(down) + 1\n            // console.log(`row = ${row}, this.rows.length=${this.rows.length}, subtreeSize = ${subtreeSize}`)\n            for(let i=0; i<subtreeSize; ++i)\n                 --this.rows[row+i].depth\n\n            this.append(down, this.getNext(this.rows[row].node))\n            this.setNext(this.rows[row].node, undefined)\n            if (row === 0) {\n                this.setRoot(down)\n            } else {\n                this.setNext(this.rows[row-1].node, down)\n            }\n        } else {\n            // move sibling to current position\n            if (row === 0) {\n                const next = this.getNext(this.rows[row].node)\n                this.setNext(this.rows[row].node, undefined)\n                this.setRoot(next)\n            } else {\n                const next = this.getNext(this.rows[row].node)\n                this.setNext(this.rows[row].node, undefined)\n\n                // this.setDown(this.rows[row-1].node, next)\n                if (this.getNext(this.rows[row-1].node) === this.rows[row].node)\n                    this.setNext(this.rows[row-1].node, next)\n                else\n                    this.setDown(this.rows[row-1].node, next)\n            }\n        }\n        this.rows.splice(row, 1)\n        this.modified.trigger(new TableEvent(TableEventType.REMOVED_ROW, row, 1))\n        return row\n    }\n\n    private append(chain: T, node?: T) {\n        if (node === undefined)\n            return\n        let p = chain\n        let next\n        while(true) {\n            next = this.getNext(p)\n            if (next === undefined)\n                break\n            p = next \n        }\n        this.setNext(p, node)\n    }\n\n    private nodeCount(node?: T): number {\n        if (node === undefined)\n            return 0\n        return 1 + this.nodeCount(this.getDown(node)) + this.nodeCount(this.getNext(node))\n    }\n\n    rows: Array<TreeModel.Row<T>>\n\n    abstract createNode(): T\n    abstract deleteNode(node: T): void\n    abstract getRoot(): T | undefined\n    abstract setRoot(node?: T): void\n    abstract getDown(node: T): T | undefined\n    abstract setDown(node: T, down?: T): void\n    abstract getNext(node: T): T | undefined\n    abstract setNext(node: T, next?: T): void\n}\n\nexport namespace TreeModel {\n    export class Row<T> {\n        node: T\n        open: boolean\n        depth: number\n        constructor(node: T, depth: number) {\n            this.node = node\n            this.depth = depth\n            this.open = true\n        }\n    }\n}\n\nexport interface TreeNode {\n    next?: TreeNode\n    down?: TreeNode\n}\n\nexport abstract class TreeNodeModel<T extends TreeNode> extends TreeModel<T> {\n    root?: T\n    constructor(nodeClass: new() => T, root?: T) {\n        super(nodeClass)\n        this.nodeClass = nodeClass\n        this.root = root\n    }\n    \n    createNode(): T { return new this.nodeClass() }\n    deleteNode(node: T): void {}\n    getRoot(): T | undefined { return this.root }\n    setRoot(node?: T): void { this.root = node }\n    getDown(node: T): T | undefined { return node.down as T }\n    setDown(node: T, down?: T): void { node.down = down }\n    getNext(node: T): T | undefined { return node.next as T }\n    setNext(node: T, next?: T): void { node.next = next }\n}\n\nclass Node {\n    label: string\n    next?: Node\n    down?: Node\n\n    static counter = 0\n\n    constructor(label?: string, next?: Node, down?: Node) {\n        if (label === undefined)\n            this.label = `#${Node.counter++}`\n        else\n            this.label = label\n        this.next = next\n        this.down = down\n    }\n    print(indent = 0) {\n        console.log(`${\"  \".repeat(indent)} ${this.label}`)\n        if (this.down)\n            this.down.print(indent+1)\n        if (this.next)\n            this.next.print(indent)\n    }\n}\n\nconst sx = 12     // horizontal step width\nconst dx = 3.5    // additional step before drawing the rectangle\nconst dy = 4.5    // step from top to rectangle\nconst rs = 8      // rectangle width and height\nconst rx = 3      // horizontal line from rectangle to data on the left\nconst item_h = 20 // height of row\n\nclass TreeNodeView extends View {\n    model: TreeModel<Node>\n    row: TreeModel.Row<Node>\n\n    constructor(model: TreeModel<Node>, row: TreeModel.Row<Node>) {\n        super()\n        this.model = model\n        this.row = row\n        this.attachShadow({mode: 'open'})\n        // this.shadowRoot!.appendChild(document.importNode(this.getStyle(), true))\n        this.shadowRoot!.appendChild(this.create())\n        // this.input = document.createElement(\"input\") \n        // this.input.oninput = () => { this.updateModel() }\n        // this.attachShadow({mode: 'open'})\n        // this.shadowRoot!.appendChild(document.importNode(textStyle, true))\n        // this.shadowRoot!.appendChild(this.input)\n    }\n\n    create(): Element {\n\n        // console.log(\"-------------------- TreeNodeView.create() -------------------------\")\n\n        let svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\")\n        svg.style.border = \"none\"\n        svg.style.display = \"block\"\n        svg.setAttributeNS(\"\", \"width\", \"70\")\n        svg.setAttributeNS(\"\", \"height\", `${item_h}`)\n\n        const d = this.row.depth\n\n        svg.appendChild(text(d*sx+dx+sx+5, dy+8, this.row.node.label))\n\n        if (this.row.node.down) {\n            // box\n            svg.appendChild(rectangle(d*sx+dx, dy, rs, rs))\n            // minus\n            svg.appendChild(line(d*sx+dx+(rs>>2), dy+(rs>>1), d*sx+dx+rs-(rs>>2), dy+(rs>>1)))\n            if (!this.row.open) {\n                // plus\n                svg.appendChild(line(d*sx+dx+(rs>>1), dy+(rs>>2), d*sx+dx+(rs>>1), dy+rs-(rs>>2)))\n            }\n            // horizontal line to data\n            svg.appendChild(line(d*sx+dx+rs, dy+(rs>>1), d*sx+dx+rs+rx, dy+(rs>>1)))\n        } else {\n            // upper vertical line instead of box\n            svg.appendChild(line(d*sx+dx+(rs>>1), dy, d*sx+dx+(rs>>1), dy+(rs>>1)))\n            // horizontal line to data\n            svg.appendChild(line(d*sx+dx+(rs>>1), dy+(rs>>1), d*sx+dx+rs+rx, dy+(rs>>1)))\n        }\n\n        // small line above box\n        svg.appendChild(line(d*sx+dx+(rs>>1),0, d*sx+dx+(rs>>1), dy))\n\n        // lines connecting nodes\n        let row\n        for(row = 0; this.model.rows[row] !== this.row; ++row) {}\n\n        // console.log(`render tree graphic for row ${row} at depth ${d}`)\n\n        for(let i=0; i<=d; ++i) {\n            // console.log(`check row ${row}, depth ${i}`)\n            for(let j=row+1; j<this.model.rowCount; ++j) {\n                if (this.model.rows[j].depth < i)\n                    break\n                if ( i === this.model.rows[j].depth) {\n                    if ( i!== d) {\n                        // long line without box\n                        svg.appendChild(line(i*sx+dx+(rs>>1),0,i*sx+dx+(rs>>1), item_h))\n                    } else {\n                        // small line below box\n                        if (row+1 < this.model.rows.length && this.model.rows[row+1].depth > this.row.depth) {\n                            // has subtree => start below box\n                            svg.appendChild(line(i*sx+dx+(rs>>1),dy+rs,i*sx+dx+(rs>>1),item_h))\n                        } else {\n                            // has no subtree => has no box => don't start below box\n                            svg.appendChild(line(i*sx+dx+(rs>>1),dy+(rs>>1),i*sx+dx+(rs>>1),item_h))\n                        }\n                    }\n                    break\n                }\n            }\n        }\n        return svg\n    }\n\n    setModel(model?: Model): void {\n    }\n}\nwindow.customElements.define(\"toad-treenode\", TreeNodeView)\n\nclass NoModel extends Model {\n}\n\nclass MyTreeModel extends TreeNodeModel<Node> {\n    getFieldModel(col: number, row: number): TextModel {\n        if (col < 0 || col >= this.colCount || row < 0 || row >= this.rowCount)\n            throw Error(`MyTreeModel.getFieldModel(${col}, ${row}) is out of range`)\n        return new NoModel() as TextModel\n    }\n\n    getFieldView(col: number, row: number): View {\n        // console.log(`MyTreeModel.getFieldView(${col}, ${row})`)\n        return new TreeNodeView(this, this.rows[row])\n    }\n}\n\nexport function myTreeTest() {\n    let tree = new MyTreeModel(Node)\n    tree.addSiblingAfter(0)\n    tree.addChildAfter(0)\n    tree.addChildAfter(1)\n    tree.addSiblingAfter(1)\n    tree.addSiblingAfter(0)\n    bind(\"books\", tree)\n}","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018, 2021 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { BooleanModel } from \"./model\"\nimport { GenericView } from \"./view\"\n\nexport { Point, MatrixStruct, Matrix } from \"./matrix\"\nexport { Signal } from \"./signal\"\nexport { Action } from \"./action\"\nexport { Model, GenericModel, TextModel, HtmlModel, NumberModel, BooleanModel, OptionModel, OptionModelBase } from \"./model\"\n\nexport { View, GenericView, ActionView, SlotView } from \"./view\"\nexport { ButtonView } from \"./view/button\"\nexport { ToolButton } from \"./view/toolbutton\"\t// FIXME: no View in name?\nexport { CheckboxView } from \"./view/checkbox\"\nexport { MenuButton } from \"./view/menu\"\t// FIXME: no View in name?\nexport { SliderView } from \"./view/slider\"\n\nexport { TableEditMode, registerTableModelLocator, createTableModel } from \"./table/table\"\nexport { TableEventType, TableEvent, TreeModel, TreeNodeModel, myTreeTest } from \"./table/tree\"\nexport { TableView } from \"./table/TableView\"\nexport { TableModel } from \"./table/TableModel\"\nexport { SelectionModel } from \"./table/SelectionModel\"\n\nexport { TextView } from \"./view/text\"\nexport { TextArea, TextTool } from \"./view/textarea\"\n\nexport {Controller, Template, Dialog, bind, action, unbind, globalController, boolean } from \"./controller\"\n\n// <toad-if> requires correct HTML otherwise <toad-if> and it's content might\n// be separated by stuff like an </p> inserted automatically by the browser\n// so one should use stuff like htmltidy or htmlhint\nclass ToadIf extends GenericView<BooleanModel> {\n  updateModel() {\n  }\n\n  updateView() {\n    if (this.model) {\n      this.style.display = this.model.value ? \"\" : \"none\"\n    }\n  }\n}\ncustomElements.define('toad-if', ToadIf)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { Model, TextModel, HtmlModel, BooleanModel, NumberModel } from \"./model\"\nimport { Controller, globalController } from \"./controller\"\n\nimport { Action } from \"./action\"\n\nexport abstract class View extends HTMLElement {\n  controller?: Controller\n\n  abstract setModel(model?: Model): void\n\n  getModelId(): string {\n    if (!this.hasAttribute(\"model\")) \n      throw Error(\"no 'model' attribute\")\n    let modelId = this.getAttribute(\"model\") // FIXME: both hasAttribute & getAttribute? really?\n    if (!modelId)\n      throw Error(\"no model id\")\n    return \"M:\"+modelId\n  }\n\n  getActionId(): string {\n    if (!this.hasAttribute(\"action\")) \n      throw Error(\"no 'action' attribute\")\n    let actionId = this.getAttribute(\"action\") // FIXME: both hasAttribute & getAttribute? really?\n    if (!actionId)\n      throw Error(\"no action id\")\n    return \"A:\"+actionId\n  }\n\n}\n\nexport abstract class GenericView<T extends Model> extends View {\n  model?: T\n\n  constructor() {\n    super()\n  }\n\n  abstract updateModel(): void\n  abstract updateView(data?: any): void\n  \n  connectedCallback() {\n    if (this.controller)\n      return\n    let modelId = \"\"\n    try {\n      modelId = this.getModelId()\n    } catch(error) {\n    }\n    if (modelId!=\"\")\n      globalController.registerView(modelId, this)\n  }\n  \n  disconnectedCallback() {\n    if (this.controller)\n      this.controller.unregisterView(this)\n  }\n\n  setModel(model?: T): void {\n    if (model === this.model)\n      return\n\n    let view = this\n    \n    if (this.model)\n      this.model.modified.remove(view)\n    \n    if (model)\n      model.modified.add((data?: any) => { view.updateView(data) }, view)\n\n    this.model = model\n    this.updateView()\n  }\n}\n\n// FIXME: ActionView should also be a template instead of having a fixed TextModel\nexport abstract class ActionView extends GenericView<TextModel> {\n  action?: Action\n\n  constructor() {\n    super()\n  }\n\n  connectedCallback() {\n    if (this.controller) {\n      this.updateView()\n      return\n    }\n\n    try {\n      globalController.registerView(this.getActionId(), this) // FIXME: don't register always on globalController\n    }\n    catch(e) {\n    }\n    \n    try {\n      globalController.registerView(this.getModelId(), this) // FIXME: don't register always on globalController\n    }\n    catch (e) {\n    }\n\n    this.updateView()\n  }\n\n  disconnectedCallback() {\n    super.disconnectedCallback()\n    if (this.controller)\n      this.controller.unregisterView(this)\n  }\n  \n  setModel(model?: Model): void {\n    if (!model) {\n      if (this.model)\n        this.model.modified.remove(this)\n      if (this.action)\n        this.action.modified.remove(this)\n      this.model = undefined\n      this.action = undefined\n      this.updateView()\n      return\n    }\n\n    if (model instanceof Action) {\n      // FIXME: what if this.action is already set?\n      this.action = model\n      this.action.modified.add(() => {\n        this.updateView()\n      }, this)\n    } else\n    if (model instanceof TextModel) {\n      // FIXME: what if this.model is already set?\n      this.model = model\n      this.model.modified.add(() => {\n        this.updateView()\n      }, this)\n    } else {\n      throw Error(\"unexpected model of type \"+model.constructor.name)\n    }\n\n    this.updateView()\n  }\n\n  isEnabled(): boolean {\n    return this.action!==undefined && this.action.enabled\n  }\n}\n\n\nexport class SlotView extends GenericView<TextModel> {\n  constructor() { super() }\n  updateModel() { }\n  updateView() {\n    if (!this.model)\n      return\n      \n    let value = this.model.value === undefined ? \"\" : this.model.value\n    if (this.model instanceof HtmlModel)\n      this.innerHTML = value\n    else\n      this.innerText = value\n  }\n}\nwindow.customElements.define(\"toad-slot\", SlotView)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { Model, TextModel, HtmlModel } from \"../model\"\nimport {ActionView } from \"../view\"\nimport { globalController } from \"../controller\"\nimport { Action } from \"../action\"\n\nlet buttonStyle = document.createElement(\"style\")\nbuttonStyle.textContent=`\n  button {\n    border: none;\n    background-color: var(--toad-primary-color, #0052cc);\n    color: #ffffff;\n    border-radius: 3px;\n    font-size: 14px;\n    font-weight: bold;\n    height: 32px;\n    line-height: 32px;\n    min-width: 24px;\n    text-shadow: none;\n    padding: 0 10px;\n    margin-right: 4px;\n  }\n  \n  button:hover {\n    background-color: #0065ff;\n  }\n  \n  button:hover:active {\n    background-color: #0049b0;\n  }\n  \n  button:disabled, button:disabled:active {\n    background-color: #888;\n  }\n`\n\nexport class ButtonView extends ActionView {\n  button: HTMLButtonElement\n  _observer?: MutationObserver\n  _timer?: number\n\n  constructor() {\n    super()\n    let buttonView = this\n    this.button = document.createElement(\"button\") as HTMLButtonElement\n    this.button.onclick = () => {\n      if (this.action)\n        this.action.trigger()\n    }\n    this.button.disabled = true\n    \n    this.attachShadow({mode: 'open'})\n    this.shadowRoot!.appendChild(document.importNode(buttonStyle, true))\n    this.shadowRoot!.appendChild(this.button)\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    if (this.children.length===0) {\n      // Chrome, Opera invoke connectedCallback() before the children are conected\n      this._observer = new MutationObserver((record: MutationRecord[], observer: MutationObserver) => {\n        if (this._timer !== undefined)\n          clearTimeout(this._timer)\n        this._timer = window.setTimeout( () => {\n          this._timer = undefined\n          this.updateView()\n        }, 100)\n      })\n      this._observer.observe(this, {\n        childList: true,\n        subtree: true,\n        characterData: true\n      })\n    }\n  }\n\n\n  updateModel() {\n  }\n\n  updateView() {\n    if (this.model && this.model.value) { // FIXME: use updateView only for Model stuff\n      if (this.model instanceof HtmlModel)\n        this.button.innerHTML = this.model.value\n      else\n        this.button.innerText = this.model.value\n    } else {\n      this.button.innerHTML = this.innerHTML\n    }\n\n    this.button.disabled = !this.isEnabled()\n    // FIXME: set \"disabled\" property of this\n  }\n}\nwindow.customElements.define(\"toad-button\", ButtonView)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { BooleanModel } from \"../model\"\nimport { GenericView } from \"../view\"\n\n/* Safari & Chrome can do this and we want this */\ndeclare global {\n  interface SVGElement {\n    focus(): void;\n  }\n}\n\n/*\nthe checkbox can be customized like this (color names are not final yet)\n\n      :root {\n        --toad-neutral-color: #000;\n        --toad-dark-color: #000;\n        --toad-light-color: #fff;\n        --toad-primary-color: #000;\n      }\n\n      toad-checkbox {\n        --border-color: #000;\n        --background-color: none;\n        --marker-color: none;\n        --checked-border-color: #000;\n        --checked-background-color: none;\n        --checked-marker-color: #000;\n      }\n*/\n\n\nlet checkboxStyle = document.createElement(\"style\")\ncheckboxStyle.textContent=`\nsvg {\n  width: 12px;\n  height: 12px;\n  vertical-align: middle;\n  margin: 3px;              /* space for the outline */\n  background: none;\n}\nsvg:focus {\n  outline-offset: -2px;     /* bring outline in touch with the svg */\n  background: #9eccfb;      /* the rectangle is rounded, fill the corners */\n  outline-color: 9eccfb;    /* outline shall be the same color used to fill the corners */\n}\n@media(pointer: coarse) { /* works on Chrome but iOS is never coarse :( */\n  svg {\n    width: 18px;\n    height: 18px;\n  }\n}\nsvg rect {\n  stroke: var(--border-color, var(--toad-neutral-color, #aaa));\n  fill: var(--background-color, #fff);\n  stroke-width: 1px;\n}\nsvg path {\n  stroke: var(--marker-color, none);\n  fill: none;\n  stroke-width: 2px;\n}\n:host([checked]) svg rect {\n  stroke: var(--checked-border-color, var(--toad-primary-color, #0052cc));\n  fill: var(--checked-background-color, var(--toad-primary-color, #0052cc));\n}\n:host([checked]) svg path {\n  stroke: var(--checked-marker-color, var(--toad-light-color, #fff));\n}\n:host([disabled]) svg rect {\n  stroke: var(--checked-border-color, var(--toad-primary-color, #bdbdbd));\n  fill: var(--checked-background-color, var(--toad-primary-color, #fff));\n}\n:host([disabled]) svg path {\n  stroke: var(--checked-marker-color, var(--toad-light-color, none));\n}\n:host([checked][disabled]) svg path {\n  stroke: var(--checked-marker-color, var(--toad-light-color, #bdbdbd));\n}`\n\nexport class CheckboxView extends GenericView<BooleanModel> {\n  constructor() {\n    super()\n    \n    let svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\")\n    svg.setAttributeNS(\"\", \"viewBox\", \"0 0 18 18\")\n\n    let rect = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\")\n    rect.setAttributeNS(\"\", \"x\", \"1\")\n    rect.setAttributeNS(\"\", \"y\", \"1\")\n    rect.setAttributeNS(\"\", \"width\", \"16\")\n    rect.setAttributeNS(\"\", \"height\", \"16\")\n    rect.setAttributeNS(\"\", \"rx\", \"3\")\n    rect.setAttributeNS(\"\", \"ry\", \"3\")\n    \n    let checkmark = document.createElementNS(\"http://www.w3.org/2000/svg\", \"path\")\n    checkmark.setAttributeNS(\"\", \"d\", \"M4 9.5 L 7.5 13 L 14.5 4\")\n\n    svg.onclick = () => {\n      this.toggle()\n    }\n    svg.setAttributeNS(\"\", \"tabindex\", \"0\")\n    svg.addEventListener(\"keydown\", (event: Event) => {\n      if ((event as KeyboardEvent).key === \" \") {\n        this.toggle()\n      }\n    })\n    svg.onmousedown = (event) => {\n      svg.focus()\n      event.preventDefault()\n    }\n    \n    svg.appendChild(rect)\n    svg.appendChild(checkmark)\n    \n    this.attachShadow({mode: 'open'})\n    this.shadowRoot!.appendChild(document.importNode(checkboxStyle, true))\n    this.shadowRoot!.appendChild(svg)\n  }\n  \n  static get observedAttributes() {return ['checked'] }\n  \n  attributeChangedCallback(name: string, oldValue?: string, newValue?: string) {\n    switch(name) {\n      case \"checked\":\n        this.updateModel()\n        break\n    }\n  }\n  \n  toggle() {\n    if (this.hasAttribute(\"disabled\"))\n      return\n    if (this.hasAttribute(\"checked\"))\n      this.removeAttribute(\"checked\")\n    else\n      this.setAttribute(\"checked\", \"\")\n    this.updateModel()\n  }\n\n  updateModel() {\n    if (this.model) {\n      this.model.value = this.hasAttribute(\"checked\")\n    }\n  }\n\n  updateView() {\n    if (!this.model) {\n      this.setAttribute(\"disabled\", \"\")\n      this.removeAttribute(\"checked\")\n      return\n    }\n    this.removeAttribute(\"disabled\")\n\n    if (this.model.value)\n      this.setAttribute(\"checked\", \"\")\n    else\n      this.removeAttribute(\"checked\")\n  }\n}\nwindow.customElements.define(\"toad-checkbox\", CheckboxView)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport * as dom from \"../dom\"\nimport { Signal } from \"../signal\"\nimport { Action } from \"../action\"\nimport { Model, TextModel, HtmlModel } from \"../model\"\nimport { GenericView } from \"../view\"\nimport {Controller, globalController } from \"../controller\"\n\nlet menuStyle = document.createElement(\"style\")\nmenuStyle.textContent=`\n  :host(.menu-button) {\n    font-family: var(--toad-font-family, sans-serif);\n    font-size: 14px;\n    font-weight: bold;\n    padding: 7px;\n    vertical-align: center;\n  \n    background: #fff;\n    color: #000;\n    cursor: default;\n  }\n  :host(.menu-button.active) {\n    background: #000;\n    color: #fff;\n  }\n  :host(.menu-button.disabled) {\n    color: #888;\n  }\n  :host(.menu-button.active.disabled) {\n    color: #888;\n  }\n  :host(.menu-button.menu-down) {\n    padding-right: 20px;\n    background-image: url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='15' height='14'><path d='M 0 4 l 10 0 l -5 5 Z' fill='#000' stroke='none'/></svg>\");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  :host(.menu-button.active.menu-down) {\n    background-image: url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='15' height='14'><path d='M 0 4 l 10 0 l -5 5 Z' fill='#fff' stroke='none'/></svg>\");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  :host(.menu-button.menu-side) {\n    padding-right: 20px;\n    background-image: url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='15' height='14'><path d='M 0 2 l 0 10 l 5 -5 Z' fill='#000' stroke='none'/></svg>\");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  :host(.menu-button.active.menu-side) {\n    background-image: url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='15' height='14'><path d='M 0 2 l 0 10 l 5 -5 Z' fill='#fff' stroke='none'/></svg>\");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  .menu-bar {\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    align-items: center;\n  }\n  .menu-popup {\n    position: fixed;\n    display: flex;\n    flex-direction: column;\n    box-shadow: 2px 2px 5px #888;\n  }\n`\n\nexport enum MenuState {\n  WAIT,\n  DOWN,\n  UP_N_HOLD,\n  DOWN_N_HOLD,\n  DOWN_N_OUTSIDE,\n  DOWN_N_INSIDE_AGAIN\n}\n\nexport enum Type {\n  BUTTON,\n  RADIOBUTTON,\n  CHECKBUTTON,\n  SEPARATOR\n}\n\n// menu node\nexport class Node {\n  title: string\n  label: string\n  shortcut?: string\n  type: string\n  modelId?: string\n\n  parent?: Node\n  down?: Node\n  next?: Node\n\n  view?: HTMLElement\n  \n  constructor(title: string, label: string, shortcut?: string, type?: string, modelId?: string) {\n    this.title = title\n    this.label = label\n    this.shortcut = shortcut\n    this.type = type ? type : \"entry\"\n    this.modelId = modelId\n  }\n  \n  isEnabled(): boolean {   // get/set\n    return true\n  }\n  \n  isAvailable(): boolean { // get/set\n    return true\n  }\n  \n  createWindowAt(parent: MenuHelper, parentView: HTMLElement): void {\n    if (this.type==\"spacer\") {\n      let span = document.createElement(\"span\") as HTMLSpanElement\n      span.style.flexGrow = \"1\"\n      parentView.appendChild(span)\n      return\n    }\n    this.view = new MenuButton(parent, this)\n    parentView.appendChild(this.view)\n  }\n  \n  deleteWindow(): void {\n  }\n}\n\n// FIXME: rename into MenuButtonContainer\nexport class MenuHelper extends HTMLElement {\n  vertical: boolean\n  closeOnClose: boolean\n  active?: MenuButton\n  state: MenuState\n  btnmaster?: MenuButton\n  parentButton?: MenuButton\n  \n  constructor() {\n    super()\n    this.vertical = true\n    this.closeOnClose = false\n    this.state = MenuState.WAIT\n  }\n}\n\nexport class Menu extends MenuHelper\n{\n  root: Node\n  view?: HTMLElement\n  _observer?: MutationObserver\n  _timer?: number\n  \n  constructor() {\n    super()\n    this.vertical = false\n    this.root = new Node(\"\", \"\", undefined, undefined)\n    \n  }\n\n  connectedCallback() {\n    this.tabIndex = 0\n\n    if (this.children.length===0) {\n      // Chrome, Opera invoke connectedCallback() before the children are conected\n      this._observer = new MutationObserver((record: MutationRecord[], observer: MutationObserver) => {\n        if (this._timer !== undefined)\n          clearTimeout(this._timer)\n        this._timer = window.setTimeout( () => {\n          this._timer = undefined\n          this.layout2nodes(this.children, this.root)\n          this.referenceActions()\n          this.createShadowDOM()\n        }, 100)\n      })\n      this._observer.observe(this, {\n        childList: true,\n        subtree: true\n      })\n    } else {\n      // Safari invokes connectedCallback() after the children are connected\n      this.layout2nodes(this.children, this.root)\n      this.referenceActions()\n      this.createShadowDOM()\n    }\n/*    \n    globalController.sigChanged.add(() => {\n      if (globalController.reasonType===\"action-add\") {\n        if (!globalController.reasonAction)\n          return\n        let node = this.findNode(globalController.reasonAction.title)\n        if (node) {\n          node.addAction(globalController.reasonAction)\n        }\n      }\n    }, this)\n*/\n  }\n  \n  disconnectedCallback() {\n//    globalController.sigChanged.remove(this)\n  }\n  \n  layout2nodes(children: HTMLCollection, parent: Node): void {\n    let node = parent.down\n    for(let child of children) {\n      let newnode: Node|undefined = undefined\n      switch(child.nodeName) {\n        case \"TOAD-MENUSPACER\":\n          newnode = new Node(\"\", \"\", \"\", \"spacer\")\n          break\n        case \"TOAD-MENUENTRY\":\n          newnode = new Node(\n            dom.attribute(child, \"name\"),\n            dom.attribute(child, \"label\"),\n            dom.attributeOrUndefined(child, \"shortcut\"),\n            dom.attributeOrUndefined(child, \"type\"),\n            dom.attributeOrUndefined(child, \"model\")\n          )\n          break\n      }\n      if (newnode) {\n        newnode.parent = parent\n        if (!node)\n          parent.down = newnode\n        else\n          node.next = newnode\n        node = newnode\n      }\n      if (!node)\n        throw Error(\"fuck\")\n      this.layout2nodes(child.children, node)\n    }\n  }\n  \n  referenceActions(): void {\n/*\n    for(let titleAndAction of globalController.actionStorage) {\n      let title = titleAndAction[0]\n      let action = titleAndAction[1]\n      let node = this.findNode(title)\n      if (node) {\n        node.addAction(action)\n      }\n    }\n*/\n  }\n  \n  findNode(str: string, parent?: Node): Node | undefined {\n    let strpos = str.indexOf(\"|\")\n    let left = strpos == -1 ? str : str.substr(0, strpos)\n    let right = strpos == -1 ? \"\" : str.substr(strpos+1)\n    \n    if (!parent)\n      parent = this.root\n    \n    for(let n=parent.down; n; n=n.next) {\n      if (n.title == left) {\n        if (!n.down) {\n          return n\n        }\n        return this.findNode(right, n)\n      }\n    }\n  \n    return undefined\n  }\n  \n  createShadowDOM() {\n    this.view = document.createElement(\"div\")\n    this.view.classList.add(\"menu-bar\")\n\n    let node = this.root.down\n    while(node) {\n      if (node.isAvailable()) {\n        node.createWindowAt(this, this.view)\n      } else {\n        node.deleteWindow()\n      }\n      node = node.next\n    }\n\n    this.attachShadow({mode: 'open'})\n    this.shadowRoot!.appendChild(document.importNode(menuStyle, true))\n    this.shadowRoot!.appendChild(this.view)\n  }\n}\nwindow.customElements.define(\"toad-menu\", Menu)\n\nclass MenuEntry extends HTMLElement {\n}\nwindow.customElements.define(\"toad-menuentry\", MenuEntry)\nclass MenuSpacer extends HTMLElement {\n}\nwindow.customElements.define(\"toad-menuspacer\", MenuSpacer)\n\nexport class PopupMenu extends MenuHelper\n{\n  root: Node\n  vertical: boolean\n  parentButton: MenuButton\n  popup: HTMLElement\n\n  constructor(root: Node, parent: MenuButton) {\n    super()\n    this.vertical = true\n    this.root = root\n    this.parentButton = parent\n\n    this.popup = document.createElement(\"div\")\n    this.popup.classList.add(\"menu-popup\")\n\n    let node = root.down\n    while(node) {\n      if (node.isAvailable()) {\n        node.createWindowAt(this, this.popup)\n      } else {\n        node.deleteWindow()\n      }\n      node = node.next\n    }\n    this.appendChild(this.popup)\n    this.show()\n  }\n    \n  \n  show() {\n    if (!this.parentButton.master!.vertical)\n      placePopupVertical(this.parentButton, this.popup)\n    else\n      placePopupHorizontal(this.parentButton, this.popup)\n    this.style.display = \"\"\n  }\n  \n  hide() {\n    this.style.display = \"none\"\n  }\n}\nwindow.customElements.define(\"toad-popupmenu\", PopupMenu)\n\nexport class MenuButton extends GenericView<TextModel> {\n  static inside?: MenuButton\n  static buttonDown: boolean\n  static documentMouseDown?: (event: MouseEvent) => void\n\n  node: Node\n  master?: MenuHelper // FIXME: rename into container\n  popup?: PopupMenu\n  \n  action?: Action\n\n  constructor(master: MenuHelper, node: Node) {\n    super()\n    this.master = master\n    this.node = node\n    let menuButton = this\n    this.classList.add(\"menu-button\")\n    if (node.down) {\n      if (master.vertical)\n        this.classList.add(\"menu-side\")\n      else\n        this.classList.add(\"menu-down\")\n    }\n    this.updateView()\n    \n    this.onmousedown = (event: MouseEvent) => {\n      event.stopPropagation()\n\n//if (this.node) console.log(\"mousedown \", this.node.title)\n\n      let documentMouseUp = function(event: MouseEvent) {\n        document.removeEventListener(\"mouseup\", documentMouseUp, {capture: true})\n        event.preventDefault()\n        setTimeout(()=>{\n          if (MenuButton.buttonDown)\n            menuButton.dispatchEvent(new MouseEvent(\"mouseup\", event))\n        }, 0)\n      }\n      document.addEventListener(\"mouseup\", documentMouseUp, {capture: true})\n      MenuButton.buttonDown = true\n\n      if (!this.master)\n        throw Error(\"fuck\")\n      switch(this.master.state) {\n        case MenuState.WAIT:\n          this.master.state = MenuState.DOWN\n          this.activate()\n          break\n        case MenuState.UP_N_HOLD:\n          if (this.master.active!==this) {\n            this.master.state = MenuState.DOWN\n            this.activate()\n          } else {\n            this.master.state = MenuState.DOWN_N_HOLD\n          }\n          break\n        default:\n          throw Error(\"unexpected state \"+this.master.state)\n      }\n      return false\n    }\n    \n    this.onmouseup = (event: MouseEvent) => {\n      event.stopPropagation()\n      if (!MenuButton.buttonDown)\n        return\n      MenuButton.buttonDown = false\n\n//if (this.node) console.log(\"mouseup \", this.node.title)\n\n      if (!this.master)\n        throw Error(\"fuck\")\n      if (!this.node)\n        throw Error(\"fuck\")\n      switch(this.master.state) {\n        case MenuState.DOWN:\n          if (this.node.isEnabled() && !this.node.down) {\n            this.trigger()\n            this.master.state = MenuState.WAIT\n          } else {\n            this.master.state = MenuState.UP_N_HOLD\n            \n            if (MenuButton.documentMouseDown) {\n              document.removeEventListener(\"mousedown\", MenuButton.documentMouseDown, {capture: false})\n            }\n            MenuButton.documentMouseDown = function(event: MouseEvent) {\n              if (MenuButton.documentMouseDown)\n                document.removeEventListener(\"mousedown\", MenuButton.documentMouseDown, {capture: false})\n              MenuButton.documentMouseDown = undefined\n              let tagName = (event.target as HTMLElement).tagName\n              if (tagName!==\"TOAD-MENUBUTTON\") {\n                menuButton.collapse()\n              }\n            }\n            document.addEventListener(\"mousedown\", MenuButton.documentMouseDown, {capture: false})\n          }\n          break\n        case MenuState.DOWN_N_HOLD:\n        case MenuState.DOWN_N_OUTSIDE:\n          this.master.state = MenuState.WAIT\n          this.deactivate()\n          this.collapse()\n          // this.dropKeyboard()\n          if (this.master.closeOnClose) {\n            // this.master.destroyWindow()\n          }\n          break\n        case MenuState.DOWN_N_INSIDE_AGAIN:\n          // this.dropKeyboard()\n          this.trigger()\n          break\n        default:\n          throw Error(\"unexpected state \"+this.master.state)\n      }\n      return false\n    }\n    \n    // leave\n    this.onmouseout = (event: MouseEvent) => {\n      event.stopPropagation()\n//console.log(\"mouseout \", this.node.title)\n      if (!this.master)\n        throw Error(\"fuck\")\n      MenuButton.inside = undefined\n      switch(this.master.state) {\n        case MenuState.WAIT:\n        case MenuState.DOWN_N_OUTSIDE:\n        case MenuState.UP_N_HOLD:\n        case MenuState.DOWN_N_HOLD:\n          break\n        case MenuState.DOWN:\n        case MenuState.DOWN_N_INSIDE_AGAIN:\n          this.master.state = MenuState.DOWN_N_OUTSIDE\n          this.updateView()\n          break;\n        default:\n          throw Error(\"unexpected state\")\n      }\n      return false\n    }\n    \n    this.onmouseover = (event: MouseEvent) => {\n      event.stopPropagation()\n//console.log(\"mouseover \", this.node.title)\n      if (!menuButton.master)\n        throw Error(\"fuck\")\n      MenuButton.inside = menuButton\n      switch(menuButton.master.state) {\n        case MenuState.WAIT:\n        case MenuState.UP_N_HOLD:\n        case MenuState.DOWN_N_OUTSIDE:\n        case MenuState.DOWN_N_HOLD:\n        case MenuState.DOWN:\n        case MenuState.DOWN_N_INSIDE_AGAIN:\n          if (!MenuButton.buttonDown)\n            break\n          if (!this.master)\n            throw Error(\"fuck\")\n          if (this.master.active)\n            this.master.active.deactivate()\n          this.master.state = MenuState.DOWN_N_INSIDE_AGAIN\n          this.activate()\n          break\n        default:\n          throw Error(\"unexpected state \"+menuButton.master.state)\n      }\n      return false\n    }\n    \n    this.attachShadow({mode: 'open'})\n    if (!this.shadowRoot)\n      throw Error(\"fuck\")\n    this.shadowRoot.appendChild(document.importNode(menuStyle, true))\n    if (!this.node.modelId)\n      this.shadowRoot.appendChild(document.createTextNode(node.label))\n  }\n\n  connectedCallback() {\n    if (this.controller)\n      return\n      \n    if (this.node.down===undefined) {\n      let actionId=this.node.title\n      for(let node=this.node.parent; node; node=node.parent) {\n        if (!node.title.length)\n          break\n        actionId=node.title+\"|\"+actionId\n      }\n      actionId = \"A:\"+actionId\n//console.log(\"*** register view action \"+actionId, this.node)\n      globalController.registerView(actionId, this)\n    }\n\n    if (this.node.modelId!==undefined) {\n      let modelId = \"M:\"+this.node.modelId\n      globalController.registerView(modelId, this)\n    }\n    \n  }\n\n  disconnectedCallback() {\n    if (this.controller)\n      this.controller.unregisterView(this)\n  }\n  \n  setModel(model?: Model): void {\n    if (!model) {\n      if (this.action)\n        this.action.modified.remove(this)\n      this.model = undefined\n      this.action = undefined\n      this.updateView()\n      return\n    }\n\n    if (model instanceof Action) {\n      this.action = model\n      this.action.modified.add(() => {\n        this.updateView()\n      }, this)\n    } else\n    if (model instanceof TextModel) {\n      this.model = model\n    } else {\n      throw Error(\"unexpected model of type \"+model.constructor.name)\n    }\n    this.updateView()\n  }\n  \n  updateModel() {\n//console.log(\"MenuButton.updateModel \"+this.node.title)\n  }\n\n  updateView(): void {\n    if (this.model && this.model.value) { // FIXME: use updateView only for Model stuff\n      if (!this.shadowRoot)\n        throw Error(\"fuck\")\n//      console.log(\"update view with model\")\n      let span = document.createElement(\"span\")\n      if (this.model instanceof HtmlModel)\n        span.innerHTML = this.model.value\n      else\n        span.innerText = this.model.value\n\n      // FIXME: dom.replaceChild(this.shadowRoot, 1, span)\n      if (this.shadowRoot.children.length>1)\n        this.shadowRoot.removeChild(this.shadowRoot.children[1])\n      if (this.shadowRoot.children.length>1)\n        this.shadowRoot.insertBefore(span, this.shadowRoot.children[1])\n      else\n        this.shadowRoot.appendChild(span)\n    }\n  \n    if (!this.master)\n      throw Error(\"fuck\")\n\n    let active = false\n    if (this.master.active==this) {\n      switch(this.master.state) {\n        case MenuState.DOWN:\n        case MenuState.UP_N_HOLD:\n        case MenuState.DOWN_N_HOLD:\n        case MenuState.DOWN_N_INSIDE_AGAIN:\n          active = true\n          break\n        case MenuState.DOWN_N_OUTSIDE:\n          if (!this.node)\n            throw Error(\"fuck\")\n          active = this.node.down!==undefined && this.node.isEnabled()\n          break\n      }\n    }\n\n    this.classList.toggle(\"active\", active)\n\n    this.classList.toggle(\"disabled\", !this.isEnabled())\n  }\n  \n  isEnabled(): boolean {\n    if (this.node.down!==undefined)\n      return true\n    return this.action!==undefined && this.action.enabled\n  }\n  \n  trigger(): void {\n    this.collapse()\n    if (!this.action)\n      return\n    this.action.trigger()\n  }\n  \n  collapse(): void {\n    if (!this.master)\n      throw Error(\"fuck\")\n    if (this.master.parentButton)\n      this.master.parentButton.collapse()\n    else\n      this.deactivate()\n  }\n  \n  openPopup(): void {\n    if (!this.node)\n      return\n    if (!this.node.down)\n      return\n\n    if (!this.shadowRoot)\n      throw Error(\"fuck\")\n\n    if (!this.popup) {\n      this.popup = new PopupMenu(this.node, this)\n      this.shadowRoot.appendChild(this.popup)\n    } else {\n      this.popup.show()\n    }\n  }\n  \n  closePopup(): void {\n    if (!this.popup)\n      return\n    if (this.popup.active)\n      this.popup.active.deactivate()\n    this.popup.hide()\n  }\n  \n  activate(): void {\n    if (!this.master)\n      throw Error(\"fuck\")\n    if (!this.node)\n      throw Error(\"fuck\")\n    \n    // if active return\n    \n    let oldActive = this.master.active\n    this.master.active = this\n    if (oldActive && oldActive!==this) {\n      oldActive.closePopup()\n      oldActive.updateView()\n    }\n    this.updateView()\n    this.openPopup()\n  }\n  \n  deactivate(): void {\n    if (!this.master)\n      throw Error(\"fuck\")\n    if (this.master.active !== this)\n      return\n    \n    this.master.active.closePopup()\n    this.master.active = undefined\n    this.master.state = MenuState.WAIT\n    this.updateView()\n  }\n  \n}\nwindow.customElements.define(\"toad-menubutton\", MenuButton)\n\nfunction placePopupVertical(parent: HTMLElement, popup: HTMLElement): void {\n  let parentBoundary = parent.getBoundingClientRect()\n\n  // FIXME: need to handle scrollLeft, scrollTop?\n\n  popup.style.opacity = \"0\"\n  popup.style.left = parentBoundary.left+\"px\"\n  popup.style.top = (parentBoundary.top+parentBoundary.height)+\"px\"\n\n  setTimeout(function() {\n    // FIXME: there might still not be enough space, might want to scroll and/or overlap parent\n    let popupBoundary = popup.getBoundingClientRect()\n    let popupBottom = parentBoundary.top + parentBoundary.height + popupBoundary.height\n    if (popupBottom > window.innerHeight) {\n      popup.style.top = (parentBoundary.top - popupBoundary.height)+\"px\"\n    }\n    let popupRight = parentBoundary.left + popupBoundary.width\n    if (popupRight > window.innerWidth) {\n       popup.style.left = (parentBoundary.left + parentBoundary.width - popupBoundary.width)+\"px\"\n    }\n    popup.style.opacity = \"1\"\n  }, 0)\n\n//  window.addEventListener(\"mouseup\", new PopupListener(popup), true)\n}\n\nfunction placePopupHorizontal(parent: HTMLElement, popup: HTMLElement): void {\n  let parentBoundary = parent.getBoundingClientRect()\n\n  // FIXME: need to handle scrollLeft, scrollTop?\n\n  popup.style.opacity = \"0\"\n  popup.style.left = (parentBoundary.left+parentBoundary.width)+\"px\"\n  popup.style.top = parentBoundary.top+\"px\"\n\n  setTimeout(function() {\n    // FIXME: there might still not be enough space, might want to scroll and/or overlap parent\n    let popupBoundary = popup.getBoundingClientRect()\n    let popupBottom = parentBoundary.top + popupBoundary.height\n    if (popupBottom > window.innerHeight) {\n      popup.style.top = (parentBoundary.top + parentBoundary.height - popupBoundary.height)+\"px\"\n    }\n    let popupRight = parentBoundary.left + parentBoundary.width + popupBoundary.width\n    if (popupRight > window.innerWidth) {\n       popup.style.left = (parentBoundary.left - popupBoundary.width)+\"px\"\n    }\n    popup.style.opacity = \"1\"\n  }, 0)\n\n//  window.addEventListener(\"mouseup\", new PopupListener(popup), true)\n}\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { NumberModel } from \"../model\"\nimport { GenericView } from \"../view\"\n\nexport class SliderView extends GenericView<NumberModel> {\n  input: HTMLInputElement\n\n  constructor() {\n    super()\n    this.input = document.createElement(\"input\") as HTMLInputElement\n    this.input.type = \"range\"\n    let view = this\n    this.input.oninput = () => { view.updateModel() }\n    this.attachShadow({mode: 'open'})\n        .appendChild(this.input)\n  }\n  \n  updateModel() {\n    if (this.model)\n      this.model.value = Number.parseFloat(this.input.value)\n  }\n\n  updateView() {\n    if (!this.model)\n      return\n    this.input.step = String(this.model.step)\n    this.input.min = String(this.model.min)\n    this.input.max = String(this.model.max)\n    this.input.value = String(this.model.value)\n  }\n}\nwindow.customElements.define(\"toad-slider\", SliderView)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { TextModel } from \"../model\"\nimport { GenericView } from \"../view\"\n\nlet textStyle = document.createElement(\"style\")\ntextStyle.textContent=`\ninput {\n/*\n  height: 2.14285714em;\n  line-height: 1.4285714285714;\n  padding: 4px 5px;\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  box-sizing: border-box;\n  margin: 2px;\n  max-width: 250px;\n  vertical-align: baseline;\n  width: 100%;\n  background-color: #fff;\n  color: #333;\n  font-size: 14px;\n*/\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  margin: 2px;\n  padding: 4px 5px;\n}\n\n:host(.embedded) input {\n  border: none 0;\n  border-radius: 0;\n  padding: 0;\n  margin: 2px;\n  width: 100%;\n  background: #fff;\n}\n`\n\nexport class TextView extends GenericView<TextModel> {\n  input: HTMLInputElement\n\n  constructor() {\n    super()\n    this.input = document.createElement(\"input\") as HTMLInputElement\n    this.input.oninput = () => { this.updateModel() }\n    this.attachShadow({mode: 'open'})\n    this.shadowRoot!.appendChild(document.importNode(textStyle, true))\n    this.shadowRoot!.appendChild(this.input)\n  }\n  \n  focus() {\n    this.input.focus()\n  }\n  blur() {\n    this.input.blur()\n  }\n  \n  static get observedAttributes() { return ['value'] }\n  \n  attributeChangedCallback(name: string, oldValue?: string, newValue?: string) {\n    switch(name) {\n      case \"value\":\n        if (this.model && newValue !== undefined)\n          this.model.value = newValue\n        break\n    }\n  }\n  \n  updateModel() {\n    if (this.model) {\n      this.model.value = this.input.value\n    }\n    this.setAttribute(\"value\", this.input.value)\n  }\n\n  updateView() {\n    if (this.model && this.input.value != this.model.value) {\n      this.input.value = this.model.value\n    }\n    this.setAttribute(\"value\", this.input.value)\n  }\n  \n  get value() {\n    return this.input.value\n  }\n  set value(value: string) {\n    this.input.value = value\n    this.updateModel() // FIXME: do we need this?\n  }\n}\nwindow.customElements.define(\"toad-text\", TextView)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {Model, TextModel, HtmlModel } from \"../model\"\nimport { GenericView } from \"../view\"\n\nlet textareaStyle = document.createElement(\"style\")\ntextareaStyle.textContent=`\n.toolbar button {\n    background: #fff;\n    color: #000;\n    border: 1px #ccc;\n    border-style: solid solid solid none;\n    padding: 5;\n    margin: 0;\n}\n\n.toolbar button.left {\n    border-style: solid;\n    border-radius: 3px 0 0 3px;\n}\n\n.toolbar button.right {\n    border: 1px #ccc;\n    border-style: solid solid solid none;\n    border-radius: 0 3px 3px 0;\n}\n\n.toolbar button.active {\n    background: linear-gradient(to bottom, #7abcff 0%,#0052cc 100%,#4096ee 100%);\n    border: 1px #0052cc solid;\n    color: #fff;\n}\n\ndiv.textarea {\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  margin: 2px;\n  padding: 4px 5px;\n  outline-offset: -2px;\n}\n\ndiv.textarea h1 {\n  font-size: 22px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea h2 {\n  font-size: 18px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea h3 {\n  font-size: 16px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea h4 {\n  font-size: 14px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea div {\n  padding: 2px 0 2px 0;\n}\n`\n\nexport class TextTool extends GenericView<Model> {\n    // FIXME: make this a list where all texttools register/unregister via connectedCallback()/disconnectedCallback()\n    // FIXME: disable texttool when it is not above an active textarea in the view hierachy\n    static texttool?: TextTool\n    \n    buttonH1: HTMLElement\n    buttonH2: HTMLElement\n    buttonH3: HTMLElement\n    buttonH4: HTMLElement\n    buttonUnorderedList: HTMLElement\n    buttonOrderedList: HTMLElement\n    \n    buttonBold: HTMLElement\n    buttonItalic: HTMLElement\n    buttonUnderline: HTMLElement\n    buttonStrikeThrough: HTMLElement\n    buttonSubscript: HTMLElement\n    buttonSuperscript: HTMLElement\n    \n    buttonJustifyLeft: HTMLElement\n    buttonJustifyCenter: HTMLElement\n    buttonJustifyRight: HTMLElement\n//    buttonJustifyFull: HTMLElement\n\n    constructor() {\n        super()\n        \n        TextTool.texttool = this\n        \n        let toolbar = document.createElement(\"div\")\n        toolbar.classList.add(\"toolbar\")\n        \n        this.buttonH1 = document.createElement(\"button\")\n        this.buttonH1.classList.add(\"left\")\n        this.buttonH1.innerHTML = \"H1\"\n        this.buttonH1.onclick = () => {\n            document.execCommand(\"formatBlock\", false, \"<h1>\")\n            this.update()\n        }\n        toolbar.appendChild(this.buttonH1)\n\n        this.buttonH2 = document.createElement(\"button\")\n        this.buttonH2.innerHTML = \"H2\"\n        this.buttonH2.onclick = () => {\n            document.execCommand(\"formatBlock\", false, \"<h2>\")\n            this.update()\n        }\n        toolbar.appendChild(this.buttonH2)\n\n        this.buttonH3 = document.createElement(\"button\")\n        this.buttonH3.innerHTML = \"H3\"\n        this.buttonH3.onclick = () => {\n            document.execCommand(\"formatBlock\", false, \"<h3>\")\n            this.update()\n        }\n        toolbar.appendChild(this.buttonH3)\n\n        this.buttonH4 = document.createElement(\"button\")\n        this.buttonH4.classList.add(\"right\")\n        this.buttonH4.innerHTML = \"H4\"\n        this.buttonH4.onclick = () => {\n            document.execCommand(\"formatBlock\", false, \"<h4>\")\n            this.update()\n        }\n        toolbar.appendChild(this.buttonH4)\n\n        toolbar.appendChild(document.createTextNode(\" \"))\n\n        this.buttonBold = document.createElement(\"button\")\n        this.buttonBold.classList.add(\"left\")\n        this.buttonBold.innerHTML = \"<b>B</b>\"\n        this.buttonBold.onclick = () => {\n            document.execCommand(\"bold\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonBold)\n\n        this.buttonItalic = document.createElement(\"button\")\n        this.buttonItalic.innerHTML = \"<i>I</i>\"\n        this.buttonItalic.onclick = () => {\n            document.execCommand(\"italic\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonItalic)\n\n        this.buttonUnderline = document.createElement(\"button\")\n        this.buttonUnderline.innerHTML = \"<u>U</u>\"\n        this.buttonUnderline.onclick = () => {\n            document.execCommand(\"underline\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonUnderline)\n\n        this.buttonStrikeThrough = document.createElement(\"button\")\n        this.buttonStrikeThrough.innerHTML = \"<strike>S</strike>\"\n        this.buttonStrikeThrough.onclick = () => {\n            document.execCommand(\"strikeThrough\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonStrikeThrough)\n\n        this.buttonSubscript = document.createElement(\"button\")\n        this.buttonSubscript.innerHTML = \"x\"\n        this.buttonSubscript.onclick = () => {\n            document.execCommand(\"subscript\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonSubscript)\n\n        this.buttonSuperscript = document.createElement(\"button\")\n        this.buttonSuperscript.classList.add(\"right\")\n        this.buttonSuperscript.innerHTML = \"x\"\n        this.buttonSuperscript.onclick = () => {\n            document.execCommand(\"superscript\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonSuperscript)\n\n\n        toolbar.appendChild(document.createTextNode(\" \"))\n\n        this.buttonJustifyLeft = document.createElement(\"button\")\n        this.buttonJustifyLeft.classList.add(\"left\")\n        this.buttonJustifyLeft.innerHTML = `<svg viewBox=\"0 0 10 9\" width=\"10\" height=\"9\">\n            <line x1=\"0\" y1=\"0.5\" x2=\"10\" y2=\"0.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"2.5\" x2=\"6\" y2=\"2.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"4.5\" x2=\"10\" y2=\"4.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"6.5\" x2=\"6\" y2=\"6.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"8.5\" x2=\"10\" y2=\"8.5\" stroke=\"#000\" />\n            </svg>`\n        this.buttonJustifyLeft.onclick = () => {\n            document.execCommand(\"justifyLeft\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonJustifyLeft)\n        \n        this.buttonJustifyCenter = document.createElement(\"button\")\n        this.buttonJustifyCenter.innerHTML = `<svg viewBox=\"0 0 10 9\" width=\"10\" height=\"9\">\n            <line x1=\"0\" y1=\"0.5\" x2=\"10\" y2=\"0.5\" stroke=\"#000\" />\n            <line x1=\"2\" y1=\"2.5\" x2=\"8\" y2=\"2.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"4.5\" x2=\"10\" y2=\"4.5\" stroke=\"#000\" />\n            <line x1=\"2\" y1=\"6.5\" x2=\"8\" y2=\"6.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"8.5\" x2=\"10\" y2=\"8.5\" stroke=\"#000\" />\n            </svg>`\n        this.buttonJustifyCenter.onclick = () => {\n            document.execCommand(\"justifyCenter\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonJustifyCenter)\n        \n        this.buttonJustifyRight = document.createElement(\"button\")\n        this.buttonJustifyRight.classList.add(\"right\")\n        this.buttonJustifyRight.innerHTML = `<svg viewBox=\"0 0 10 9\" width=\"10\" height=\"9\">\n            <line x1=\"0\" y1=\"0.5\" x2=\"10\" y2=\"0.5\" stroke=\"#000\" />\n            <line x1=\"4\" y1=\"2.5\" x2=\"10\" y2=\"2.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"4.5\" x2=\"10\" y2=\"4.5\" stroke=\"#000\" />\n            <line x1=\"4\" y1=\"6.5\" x2=\"10\" y2=\"6.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"8.5\" x2=\"10\" y2=\"8.5\" stroke=\"#000\" />\n            </svg>`\n        this.buttonJustifyRight.onclick = () => {\n            document.execCommand(\"justifyRight\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonJustifyRight)\n\n/*        \n        this.buttonJustifyFull = document.createElement(\"button\")\n        this.buttonJustifyFull.classList.add(\"right\")\n        this.buttonJustifyFull.innerHTML = `<svg viewBox=\"0 0 10 9\" width=\"10\" height=\"9\">\n            <line x1=\"0\" y1=\"0.5\" x2=\"10\" y2=\"0.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"2.5\" x2=\"10\" y2=\"2.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"4.5\" x2=\"10\" y2=\"4.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"6.5\" x2=\"10\" y2=\"6.5\" stroke=\"#000\" />\n            <line x1=\"0\" y1=\"8.5\" x2=\"10\" y2=\"8.5\" stroke=\"#000\" />\n            </svg>`\n        this.buttonJustifyFull.onclick = () => {\n            document.execCommand(\"justifyFull\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonJustifyFull)\n*/        \n        toolbar.appendChild(document.createTextNode(\" \"))\n\n        this.buttonUnorderedList = document.createElement(\"button\")\n        this.buttonUnorderedList.classList.add(\"left\")\n        this.buttonUnorderedList.innerHTML = `<svg viewBox=\"0 0 17 10.5\" width=\"17\" height=\"10.5\">\n            <circle cx=\"4.5\" cy=\"1.5\" r=\"0.8\" stroke=\"#000\" fill=\"#000\"/>\n            <line x1=\"7\" y1=\"1.5\" x2=\"17\" y2=\"1.5\" stroke=\"#000\"/>\n            <circle cx=\"4.5\" cy=\"5.5\" r=\"0.8\" stroke=\"#000\" fill=\"#000\"/>\n            <line x1=\"7\" y1=\"5.5\" x2=\"17\" y2=\"5.5\" stroke=\"#000\"/>\n            <circle cx=\"4.5\" cy=\"9.5\" r=\"0.8\" stroke=\"#000\" fill=\"#000\"/>\n            <line x1=\"7\" y1=\"9.5\" x2=\"17\" y2=\"9.5\" stroke=\"#000\"/>\n            </svg>`\n        this.buttonUnorderedList.onclick = (event) => {\n            document.execCommand(\"insertUnorderedList\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonUnorderedList)\n        \n        this.buttonOrderedList = document.createElement(\"button\")\n        this.buttonOrderedList.classList.add(\"right\")\n        this.buttonOrderedList.innerHTML = `<svg viewBox=\"0 0 17 10.5\" width=\"17\" height=\"10.5\">\n            <line x1=\"4.5\" y1=\"0\" x2=\"4.5\" y2=\"3\" stroke=\"#000\" />\n            <line x1=\"7\" y1=\"1.5\" x2=\"17\" y2=\"1.5\" stroke=\"#000\"/>\n            <line x1=\"2.5\" y1=\"4\" x2=\"2.5\" y2=\"7\" stroke=\"#000\" />\n            <line x1=\"4.5\" y1=\"4\" x2=\"4.5\" y2=\"7\" stroke=\"#000\" />\n            <line x1=\"7\" y1=\"5.5\" x2=\"17\" y2=\"5.5\" stroke=\"#000\"/>\n            <line x1=\"0.5\" y1=\"8\" x2=\"0.5\" y2=\"11\" stroke=\"#000\" />\n            <line x1=\"2.5\" y1=\"8\" x2=\"2.5\" y2=\"11\" stroke=\"#000\" />\n            <line x1=\"4.5\" y1=\"8\" x2=\"4.5\" y2=\"11\" stroke=\"#000\" />\n            <line x1=\"7\" y1=\"9.5\" x2=\"17\" y2=\"9.5\" stroke=\"#000\"/>\n            </svg>`\n        this.buttonOrderedList.onclick = () => {\n            document.execCommand(\"insertOrderedList\", false)\n            this.update()\n        }\n        toolbar.appendChild(this.buttonOrderedList)\n\n        this.attachShadow({mode: 'open'})\n        this.shadowRoot!.appendChild(document.importNode(textareaStyle, true))\n        this.shadowRoot!.appendChild(toolbar)\n    }\n    \n    update() {\n        this.buttonH1.classList.toggle(\"active\", document.queryCommandValue(\"formatBlock\") === \"h1\")\n        this.buttonH2.classList.toggle(\"active\", document.queryCommandValue(\"formatBlock\") === \"h2\")\n        this.buttonH3.classList.toggle(\"active\", document.queryCommandValue(\"formatBlock\") === \"h3\")\n        this.buttonH4.classList.toggle(\"active\", document.queryCommandValue(\"formatBlock\") === \"h4\")\n        \n        this.buttonBold.classList.toggle(\"active\", document.queryCommandState(\"bold\"))\n        this.buttonItalic.classList.toggle(\"active\", document.queryCommandState(\"italic\"))\n        this.buttonUnderline.classList.toggle(\"active\", document.queryCommandState(\"underline\"))\n        this.buttonStrikeThrough.classList.toggle(\"active\", document.queryCommandState(\"strikeThrough\"))\n        this.buttonSubscript.classList.toggle(\"active\", document.queryCommandState(\"subscript\"))\n        this.buttonSuperscript.classList.toggle(\"active\", document.queryCommandState(\"superscript\"))\n        \n        this.buttonJustifyLeft.classList.toggle(\"active\", document.queryCommandState(\"justifyLeft\"))\n        this.buttonJustifyCenter.classList.toggle(\"active\", document.queryCommandState(\"justifyCenter\"))\n        this.buttonJustifyRight.classList.toggle(\"active\", document.queryCommandState(\"justifyRight\"))\n//        this.buttonJustifyFull.classList.toggle(\"active\", document.queryCommandState(\"justifyFull\"))\n    }\n    \n    updateModel() {\n        if (this.model) {\n        }\n    }\n    \n    updateView() {\n        if (!this.model) {\n            return\n        }\n    }\n}\nwindow.customElements.define(\"toad-texttool\", TextTool)\n\nexport class TextArea extends GenericView<TextModel> {\n\n    content: HTMLElement\n\n    constructor() {\n        super()\n\n        // FIXME: when model is not HtmlModel but TextModel, use <textarea> instead of <div contenteditable>\n        let content = document.createElement(\"div\")\n        this.content = content\n        content.classList.add(\"textarea\")\n        content.contentEditable = \"true\"\n        \n        content.oninput = (event: Event) => {\n            let firstChild = (event.target as Node).firstChild\n            if (firstChild && firstChild.nodeType === 3) {\n                // if the document starts with text, wrap it into a paragraph\n                document.execCommand(\"formatBlock\", false, `<div>`)\n            }\n            else if (content.innerHTML === \"<br>\") {\n                content.innerHTML = \"\"\n            }\n            this.updateModel()\n        }\n        \n        content.onkeydown = (event: KeyboardEvent) => {\n            if (event.metaKey === true && event.key === \"b\") {\n                event.preventDefault()\n                document.execCommand(\"bold\", false)\n                this.updateTextTool()\n            } else\n            if (event.metaKey === true && event.key === \"i\") {\n                event.preventDefault()\n                document.execCommand(\"italic\", false)\n                this.updateTextTool()\n            } else\n            if (event.metaKey === true && event.key === \"u\") {\n                event.preventDefault()\n                document.execCommand(\"underline\", false)\n                this.updateTextTool()\n            } else\n            if (event.key === \"Tab\") {\n                event.preventDefault()\n            } else\n            if (event.key === \"Enter\" &&\n                event.shiftKey !== true &&\n                document.queryCommandValue(\"formatBlock\") === \"blockquote\" )\n            {\n                document.execCommand(\"formatBlock\", false, \"<p>\")\n            }\n/*\n            else if (event.key === \"Enter\" &&\n                event.shiftKey === true )\n            {\n                event.preventDefault()\n            \n                // entering <br> with execCommand will also insert a paragraph, hence the following.\n                // beware! it is not perfect when inserting <br> at the end of the document.\n                // sometimes is works, sometimes it doesn't\n                let docFragment = document.createDocumentFragment()\n\n                let lineBreak = document.createElement(\"br\")\n                docFragment.appendChild(lineBreak)\n                let lineCR = document.createTextNode(\"\\n\")\n                docFragment.appendChild(lineCR)\n\n                // replace selection with <br>\\n\n                let range = window.getSelection().getRangeAt(0)\n                range.deleteContents()\n                range.insertNode(docFragment)\n\n                // create a new range\n                range = document.createRange()\n                range.setStartAfter(lineCR);\n                range.collapse(true)\n\n                // move cursor\n                let selection = window.getSelection()\n                selection.removeAllRanges()\n                selection.addRange(range)\n\n                this.updateTextTool()\n            }\n*/\n        }\n        \n        content.onkeyup = () => {\n            this.updateTextTool()\n        }\n        content.onmouseup = () => {\n            this.updateTextTool()\n        }\n\n        this.attachShadow({mode: 'open'})\n        this.shadowRoot!.appendChild(document.importNode(textareaStyle, true))\n        this.shadowRoot!.appendChild(content)\n    }\n    \n    updateTextTool() {\n        if (TextTool.texttool !== undefined)\n            TextTool.texttool.update()\n    }\n    \n    updateModel() {\n        if (this.model) {\n            // textarea with it's markup may be expensive, hence we let the model fetch it's data on demand\n            this.model.promise = () => {\n                return this.content.innerHTML\n            }\n        }\n    }\n    \n    updateView() {\n        if (!this.model) {\n            return\n        }\n        if (this.model instanceof HtmlModel) {\n            // because of TextModel.promise we check here instead inside the model\n            // if we don't check at all, the cursor ends up in the wrong location\n            // after each change\n            if (this.content.innerHTML !== this.model.value) {\n                this.content.innerHTML = this.model.value\n            }\n        } else {\n            // FIXME: no tested\n            if (this.content.innerText !== this.model.value) {\n                this.content.innerText = this.model.value\n            }\n        }\n    }\n}\nwindow.customElements.define(\"toad-textarea\", TextArea)\n","/*\n *  The TOAD JavaScript/TypeScript GUI Library\n *  Copyright (C) 2018 Mark-Andr Hopf <mhopf@mark13.org>\n *\n *  This program is free software: you can redistribute it and/or modify\n *  it under the terms of the GNU General Public License as published by\n *  the Free Software Foundation, either version 3 of the License, or\n *  (at your option) any later version.\n *\n *  This program is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU General Public License for more details.\n *\n *  You should have received a copy of the GNU General Public License\n *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { OptionModelBase } from \"../model\"\nimport {GenericView } from \"../view\"\n\nlet toolbuttonStyle = document.createElement(\"style\")\ntoolbuttonStyle.textContent=`\ndiv {\n    border: 1px solid #e3dbdb;\n    border-radius: 5px;\n    background: #e3dbdb;\n    width: 32px;\n    height: 32px;\n    padding: 3px;\n}\n\n:host([selected]) div {\n    background: #ac9393;\n}\n\n:host([disabled]) div {\n    opacity: 0.5;\n}\n\n:host([disabled]) div img {\n    opacity: 0.5;\n}\n\n:host([checked][disabled]) div {\n}\n`\n\nexport class ToolButton extends GenericView<OptionModelBase> {\n    constructor() {\n        super()\n        \n        let button = document.createElement(\"div\")\n        // button.setAttribute(\"tabindex\", \"0\")\n        button.onmousedown = (event) => {\n            if (this.hasAttribute(\"disabled\"))\n                return\n            button.focus()\n            event.preventDefault()\n            if (this.model !== undefined)\n                this.model.stringValue = this.getValue()\n        }\n\n        let img = document.createElement(\"img\")\n        if (this.hasAttribute(\"img\")) {\n            img.src = this.getAttribute(\"img\")!\n        }\n        button.appendChild(img)\n\n        this.attachShadow({mode: 'open'})\n        this.shadowRoot!.appendChild(document.importNode(toolbuttonStyle, true))\n        this.shadowRoot!.appendChild(button)\n    }\n\n    getValue(): string {\n        let value = this.getAttribute(\"value\")\n        if (value === null)\n            throw Error(\"no value\")\n        return value\n    }\n\n    connectedCallback() {\n        super.connectedCallback()\n        if (this.model === undefined)\n            this.setAttribute(\"disabled\", \"\")\n    }\n    \n    updateModel() {\n    }\n    \n    updateView() {\n        if (this.model === undefined) {\n            this.setAttribute(\"disabled\", \"\")\n            this.removeAttribute(\"selected\")\n            return\n        }\n        let value = this.getValue()\n        if (this.model.isValidStringValue(value)) {\n            this.removeAttribute(\"disabled\")\n        } else {\n            this.setAttribute(\"disabled\", \"\")\n        }\n        if (this.model.stringValue === value) {\n            this.setAttribute(\"selected\", \"\")\n        } else {\n            this.removeAttribute(\"selected\")\n        }\n    }\n}\nwindow.customElements.define(\"toad-toolbutton\", ToolButton)\n"],"sourceRoot":""}